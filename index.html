<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>MÃ©tÃ©o Zimmersheim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: black;
      color: white;
      overflow-x: hidden;
    }
    #app {
      position: relative;
      z-index: 1;
      padding: 20px;
    }
    .top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .info, .map {
      background: rgba(0,0,0,0.6);
      padding: 15px;
      margin: 10px;
      border-radius: 10px;
    }
    iframe {
      width: 400px;
      height: 250px;
      border: none;
      border-radius: 10px;
    }
    canvas {
      background: rgba(255,255,255,0.1);
      margin: 20px 0;
      border-radius: 10px;
    }
    #background {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 0;
      background-size: cover;
      background-position: center;
      transition: background-image 1s ease-in-out;
    }
  </style>
</head>
<body>

<div id="background"></div>
<div id="app">
  <div class="top">
    <div class="info" id="weather-info">
      <h2>Zimmersheim</h2>
      <p><strong>Condition :</strong> <span id="condition"></span></p>
      <p><strong>TempÃ©rature :</strong> <span id="temp"></span> Â°C</p>
      <p><strong>HumiditÃ© :</strong> <span id="humidity"></span> %</p>
      <p><strong>Vent :</strong> <span id="wind"></span> km/h <span id="windDirTxt"></span> (<span id="windDeg"></span>Â°)</p>
      <p><strong>Pression :</strong> <span id="pressure"></span> hPa</p>
      <p><strong>Lever :</strong> <span id="sunrise"></span> | <strong>Coucher :</strong> <span id="sunset"></span></p>
      <p><strong>Lune :</strong> <span id="moon"></span></p>
    </div>
    <div class="map">
      <iframe src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d10799.244214235972!2d7.393!3d47.721!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x47919efc604eb70d%3A0xa1f8ea5dd0cd44ed!2sZimmersheim!5e0!3m2!1sfr!2sfr!4v1688381215686!5m2!1sfr!2sfr" loading="lazy"></iframe>
    </div>
  </div>

  <canvas id="mainChart" height="120"></canvas>
  <canvas id="windChart" height="100"></canvas>
</div>

<script>
const apiKey = 'f59e1314a26b162f41dabbc7bb2b7719';
const city = 'Zimmersheim,fr';
const units = 'metric';
const lang = 'fr';

const windDirs = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
                  "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW", "N"];

function getCardinal(deg) {
  const index = Math.round(deg / 22.5);
  return windDirs[index];
}

function setBackground(condition) {
  let bg = '';
  if (condition.includes('nuage')) bg = 'clouds.gif';
  else if (condition.includes('pluie')) bg = 'rain.gif';
  else if (condition.includes('neige')) bg = 'snow.gif';
  else if (condition.includes('orage')) bg = 'storm.gif';
  else bg = 'sun.gif';
  document.getElementById('background').style.backgroundImage = `url("assets/${bg}")`;
}

function getMoonPhase(date) {
  const lp = 2551443;
  const now = new Date(date);
  const new_moon = new Date(2001, 0, 1, 0, 0, 0);
  const phase = ((now.getTime() - new_moon.getTime()) / 1000) % lp;
  const phaseIndex = Math.floor((phase / lp) * 8);
  return ["ðŸŒ‘ Nouvelle", "ðŸŒ’ Croissante", "ðŸŒ“ Premier quartier", "ðŸŒ” Gibbeuse croissante", "ðŸŒ• Pleine", "ðŸŒ– Gibbeuse dÃ©croissante", "ðŸŒ— Dernier quartier", "ðŸŒ˜ DÃ©croissante"][phaseIndex];
}

async function fetchWeather() {
  const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=${units}&lang=${lang}`);
  const data = await res.json();

  const current = data.list[0];
  const condition = current.weather[0].description;
  const deg = current.wind.deg;
  const sunrise = new Date(data.city.sunrise * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  const sunset = new Date(data.city.sunset * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  const moon = getMoonPhase(new Date());

  document.getElementById('condition').textContent = condition;
  document.getElementById('temp').textContent = Math.round(current.main.temp);
  document.getElementById('humidity').textContent = current.main.humidity;
  document.getElementById('wind').textContent = Math.round(current.wind.speed * 3.6);
  document.getElementById('windDeg').textContent = deg;
  document.getElementById('windDirTxt').textContent = getCardinal(deg);
  document.getElementById('pressure').textContent = current.main.pressure;
  document.getElementById('sunrise').textContent = sunrise;
  document.getElementById('sunset').textContent = sunset;
  document.getElementById('moon').textContent = moon;

  setBackground(condition);
  drawCharts(data.list);
}

function drawCharts(data) {
  const labels = data.map(d => new Date(d.dt * 1000).toLocaleString('fr-FR', {weekday: 'short', hour: '2-digit'}));
  const temp = data.map(d => d.main.temp);
  const hum = data.map(d => d.main.humidity);
  const press = data.map(d => d.main.pressure);
  const pluie = data.map(d => d.rain ? d.rain['3h'] || 0 : 0);
  const neige = data.map(d => d.snow ? d.snow['3h'] || 0 : 0);
  const vent = data.map(d => d.wind.speed * 3.6);
  const light = data.map(d => d.visibility ? d.visibility / 100 : 0);
  const direction = data.map(d => d.wind.deg);

  new Chart(mainChart, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {label: 'TempÃ©rature (Â°C)', data: temp, borderColor: 'red', borderWidth: 2, fill: false},
        {label: 'HumiditÃ© (%)', data: hum, borderColor: 'blue', borderWidth: 2, fill: false},
        {label: 'Pression (hPa)', data: press, borderDash: [5,5], borderColor: 'white', fill: false},
        {label: 'Pluie (mm)', data: pluie, type: 'bar', backgroundColor: '#66f'},
        {label: 'Neige (mm)', data: neige, type: 'bar', backgroundColor: '#ccf'}
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: 'white' }}},
      scales: {
        x: { ticks: { color: 'white' }},
        y: { ticks: { color: 'white' }}
      }
    }
  });

  new Chart(windChart, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {label: 'Vent (km/h)', data: vent, borderColor: 'cyan', borderWidth: 2, fill: false},
        {label: 'LuminositÃ© (%)', data: light, borderColor: 'yellow', borderWidth: 2, fill: false},
        {label: 'Direction du vent (Â°)', data: direction, borderColor: 'orange', borderWidth: 2, fill: false}
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: 'white' }},
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const val = ctx.raw;
              if (ctx.dataset.label.includes('Direction')) {
                return `${ctx.dataset.label}: ${Math.round(val)}Â° (${getCardinal(val)})`;
              }
              return `${ctx.dataset.label}: ${Math.round(val)}`;
            }
          }
        }
      },
      scales: {
        x: { ticks: { color: 'white' }},
        y: {
          ticks: {
            color: 'white',
            callback: function(value, index, values) {
              if (this.chart.data.datasets[2]) {
                if (value % 45 === 0) return `${value}Â° (${getCardinal(value)})`;
              }
              return value;
            }
          }
        }
      }
    }
  });
}

fetchWeather();
</script>

</body>
</html>
