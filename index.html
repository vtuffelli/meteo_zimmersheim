<!DOCTYPE html>
<html lang="fr">  
<head>  
<meta charset="UTF-8" />  
<meta name="viewport" content="width=device-width, initial-scale=1" />  
<title>M√©t√©o compl√®te Zimmersheim - am√©lior√©e</title>  
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
<style>  
  body, html {  
    margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;  
    background: linear-gradient(to bottom, #87ceeb, #f0f8ff);  
    color: #222;  
    overflow-x: hidden;  
  }  
  /* Fond anim√© simplifi√© */  
  #background-anim {  
    position: fixed;  
    top:0; left:0; right:0; bottom:0;  
    z-index: -1;  
    pointer-events: none;  
    overflow: hidden;  
  }  
  /* Nuages anim√©s */  
  .cloud {  
    position: absolute;  
    background: #fff;  
    background: linear-gradient(to bottom, #f0f4f8, #cbd6e8);  
    border-radius: 50px;  
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));  
    animation: cloudMove linear infinite;  
    opacity: 0.8;  
  }  
  .cloud::before, .cloud::after {  
    content: '';  
    position: absolute;  
    background: inherit;  
    border-radius: 50px;  
  }  
  .cloud::before {  
    width: 60px; height: 60px;  
    top: -30px; left: 10px;  
  }  
  .cloud::after {  
    width: 50px; height: 50px;  
    top: -20px; left: 45px;  
  }  
  @keyframes cloudMove {  
    0% { left: -150px; }  
    100% { left: 110vw; }  
  }  
  /* Pluie anim√©e */
  .rain {
    position: absolute;
    width: 2px; height: 15px;
    background: rgba(0, 150, 255, 0.5);
    border-radius: 50%;
    animation: rainFall linear infinite;
  }
  @keyframes rainFall {
    0% { top: -20px; opacity: 1; }
    100% { top: 110vh; opacity: 0; }
  }
  /* Neige anim√©e */
  .snow {
    position: absolute;
    width: 8px; height: 8px;
    background: white;
    border-radius: 50%;
    filter: drop-shadow(0 0 1px #aaa);
    animation: snowFall linear infinite;
  }
  @keyframes snowFall {
    0% { top: -10px; opacity: 1; transform: translateX(0); }
    100% { top: 110vh; opacity: 0; transform: translateX(20px); }
  }

  #container {
    display: flex; max-width: 1200px; margin: 30px auto; gap: 20px;
    flex-wrap: wrap;
  }
  #left-panel {
    flex: 1 1 350px;
    background: rgba(255,255,255,0.9);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 0 30px rgba(0,0,0,0.1);
    user-select: none;
  }
  #right-panel {
    flex: 1 1 600px;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 0 30px rgba(0,0,0,0.1);
  }
  #right-panel iframe {
    width: 100%; height: 300px; border: none;
  }
  h1, h2 {
    margin-bottom: 15px; user-select: none;
    text-align: center;
  }
  .info-row {
    margin: 10px 0;
    font-size: 1.1rem;
    display: flex; align-items: center; justify-content: space-between;
  }
  .label {
    font-weight: 700;
    color: #555;
  }
  #condition-icon {
    display: block;
    margin: 10px auto;
    width: 100px; height: 100px;
  }
  /* Fl√®che direction vent */
  #wind-arrow {
    display: inline-block;
    width: 24px; height: 24px;
    margin-left: 8px;
    vertical-align: middle;
    transition: transform 0.3s ease;
  }
  /* Graphiques */
  section.chart-section {
    background: rgba(255,255,255,0.95);
    margin: 30px auto;
    max-width: 1200px;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 0 30px rgba(0,0,0,0.08);
    user-select: none;
  }
  canvas {
    width: 100% !important;
    max-height: 400px !important;
  }
</style>

</head>  
<body>  
  <div id="background-anim"></div>  
  <div id="container">  
    <div id="left-panel">  
      <h1>M√©t√©o actuelle - Zimmersheim</h1>  
      <img id="condition-icon" src="" alt="Ic√¥ne m√©t√©o" />  
      <div class="info-row"><span class="label">Condition :</span> <span id="description"></span></div>  
      <div class="info-row"><span class="label">Temp√©rature :</span> <span id="temp"></span> ¬∞C</div>  
      <div class="info-row"><span class="label">Humidit√© :</span> <span id="humidity"></span> %</div>  
      <div class="info-row"><span class="label">Pr√©cipitations (1h) :</span> <span id="precip"></span></div>  
      <div class="info-row"><span class="label">Pression :</span> <span id="pressure"></span> hPa</div>  
      <div class="info-row">  
        <span class="label">Vent :</span>   
        <span id="wind"></span> km/h  
        <svg id="wind-arrow" viewBox="0 0 24 24" fill="none" stroke="#0077cc" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" >  
          <line x1="12" y1="19" x2="12" y2="5"></line>  
          <polyline points="5 12 12 5 19 12"></polyline>  
        </svg>  
      </div>  
      <div class="info-row">  
        <span class="label">Direction vent :</span>   
        <span id="wind-dir"></span>  
      </div>  
      <div class="info-row"><span class="label">Lever du soleil :</span> <span id="sunrise"></span></div>  
      <div class="info-row"><span class="label">Coucher du soleil :</span> <span id="sunset"></span></div>  
    </div>    
    <div id="right-panel">  
      <h2 style="text-align:center; padding: 10px 0;">Vue satellite - Zimmersheim</h2>  
      <!-- Google Maps satellite, zoom et vue large -->  
      <iframe  
        id="map-frame"  
        src="https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d2777.8758572121094!2d7.337325815711999!3d47.7745615792057!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0!3m2!1sfr!2sfr!4v1691246400000!5m2!1sfr!2sfr&layer=c"  
        allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">  
      </iframe>  
    </div>  
  </div>  
  <section class="chart-section">  
    <h2>üìä Graphique principal</h2>  
    <canvas id="mainChart"></canvas>  
  </section>  
  <section class="chart-section">  
    <h2>üìä Graphique secondaire (vent)</h2>  
    <canvas id="windChart"></canvas>  
  </section>  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
  <script>  
    const apiKey = "f59e1314a26b162f41dabbc7bb2b7719"; // Remplace par ta cl√© OpenWeatherMap  
    const city = "Zimmersheim,fr";  
    const units = "metric";  
    const lang = "fr";  
    
    const conditionIcon = document.getElementById('condition-icon');  
    const windArrow = document.getElementById('wind-arrow');  
    const windDirSpan = document.getElementById('wind-dir');  
    
    function degToCardinal(deg) {  
      if (deg == null) return "N/A";  
      const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE',  
                          'S', 'SSO', 'SO', 'OSO', 'O', 'ONO', 'NO', 'NNO'];  
      const index = Math.floor(((deg + 11.25) % 360) / 22.5);  
      return directions[index];  
    }  
    
    function formatTime(unixTimestamp) {  
      const d = new Date(unixTimestamp * 1000);  
      return d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });  
    }  
    
    function clearChildren(parent) {  
      while (parent.firstChild) parent.removeChild(parent.firstChild);  
    }  
    
    // Cr√©e les nuages anim√©s  
    function createClouds() {  
      const container = document.getElementById('background-anim');  
      clearChildren(container);  
      for (let i=0; i<5; i++) {  
        const cloud = document.createElement('div');  
        cloud.className = 'cloud';  
        cloud.style.top = (20 + i*50) + 'px';  
        cloud.style.width = (80 + Math.random()*60) + 'px';  
        cloud.style.height = '50px';  
        cloud.style.animationDuration = (30 + Math.random()*40) + 's';  
        cloud.style.animationDelay = (-Math.random()*60) + 's';  
        container.appendChild(cloud);  
      }  
    }  
    
    // Cr√©e la pluie anim√©e  
    function createRain() {  
      const container = document.getElementById('background-anim');  
      clearChildren(container);  
      for (let i=0; i<50; i++) {  
        const drop = document.createElement('div');  
        drop.className = 'rain';  
        drop.style.left = (Math.random() * window.innerWidth) + 'px';  
        drop.style.animationDuration = (0.5 + Math.random()*0.5) + 's';  
        drop.style.animationDelay = (-Math.random()*1) + 's';  
        container.appendChild(drop);  
      }  
    }  
    
    // Cr√©e la neige anim√©e  
    function createSnow() {  
      const container = document.getElementById('background-anim');  
      clearChildren(container);  
      for (let i=0; i<40; i++) {  
        const flake = document.createElement('div');  
        flake.className = 'snow';  
        flake.style.left = (Math.random() * window.innerWidth) + 'px';  
        flake.style.animationDuration = (3 + Math.random()*4) + 's';  
        flake.style.animationDelay = (-Math.random()*7) + 's';  
        container.appendChild(flake);  
      }  
    }  
    
    // Supprime toute animation  
    function clearAnimations() {  
      const container = document.getElementById('background-anim');  
      clearChildren(container);  
    }  
    
    async function fetchWeather() {  
      try {  
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=${units}&lang=${lang}`);  
        const data = await res.json();  
    
        document.getElementById("description").textContent = data.weather[0].description;  
        document.getElementById("temp").textContent = Math.round(data.main.temp);  
        document.getElementById("humidity").textContent = data.main.humidity;  
        let precip = 0;  
        if(data.rain && data.rain["1h"]) precip += data.rain["1h"];  
        if(data.snow && data.snow["1h"]) precip += data.snow["1h"];  
        document.getElementById("precip").textContent = precip > 0 ? precip.toFixed(1) + " mm" : "Aucune";  
    
        document.getElementById("pressure").textContent = data.main.pressure;  
        document.getElementById("wind").textContent = Math.round(data.wind.speed * 3.6);  
    
        // Direction vent cardinal + rotation fl√®che  
        const deg = data.wind.deg;  
        const cardinal = degToCardinal(deg);  
        windDirSpan.textContent = `${cardinal} (${deg}¬∞)`;  
        windArrow.style.transform = `rotate(${deg}deg)`;  
    
        document.getElementById("sunrise").textContent = formatTime(data.sys.sunrise);  
        document.getElementById("sunset").textContent = formatTime(data.sys.sunset);  
    
        conditionIcon.src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@4x.png`;  
        conditionIcon.alt = data.weather[0].description;  
    
        // Calcul luminosit√© corrig√©e selon n√©bulosit√© (couverture nuageuse en %)  
        let luminosityPercent = 100;  
        if (data.clouds && data.clouds.all != null) {  
          luminosityPercent = Math.round(100 * (1 - data.clouds.all / 100));  
        }  
        // Stocke pour le graphique secondaire  
        window.luminosityCorrected = luminosityPercent;  
    
        // Fond anim√© selon m√©t√©o principale  
        const main = data.weather[0].main.toLowerCase();  
        if(main.includes("rain")) createRain();  
        else if(main.includes("snow")) createSnow();  
        else if(main.includes("cloud")) createClouds();  
        else clearAnimations();  
    
      } catch (e) {  
        console.error("Erreur m√©t√©o actuelle :", e);  
        alert("Erreur lors de la r√©cup√©ration de la m√©t√©o actuelle.");  
      }  
    }  
    
    async function fetchForecast() {  
      try {  
        const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=${units}&lang=${lang}`);  
        const data = await res.json();  
    
        const labels = [];  
        const temps = [];  
        const humidities = [];  
        const pressures = [];  
        const rains = [];  
        const snows = [];  
        const winds = [];  
        const windDirs = [];  
    
        data.list.forEach(item => {  
          const date = new Date(item.dt * 1000);  
          const label = date.toLocaleString('fr-FR', { weekday: 'short', hour: '2-digit', minute: '2-digit' });  
          labels.push(label);  
    
          temps.push(item.main.temp);  
          humidities.push(item.main.humidity);  
          pressures.push(item.main.pressure);  
          rains.push(item.rain?.["3h"] || 0);  
          snows.push(item.snow?.["3h"] || 0);  
          winds.push(item.wind.speed * 3.6);  
          windDirs.push(item.wind.deg);  
        });  
    
        // Graphique principal sans remplissage  
        const ctxMain = document.getElementById("mainChart").getContext("2d");  
        new Chart(ctxMain, {  
          type: 'line',  
          data: {  
            labels,  
            datasets: [  
              {  
                label: "Temp√©rature (¬∞C)",  
                data: temps,  
                borderColor: "red",  
                backgroundColor: "transparent",  
                yAxisID: 'y1',  
                tension: 0.3,  
                fill: false,  
                pointRadius: 3,  
              },  
              {  
                label: "Humidit√© (%)",  
                data: humidities,  
                borderColor: "blue",  
                backgroundColor: "transparent",  
                yAxisID: 'y2',  
                tension: 0.3,  
                fill: false,  
                pointRadius: 3,  
              },  
              {  
                label: "Pluie + Neige (mm)",  
                data: rains.map((r,i) => r + snows[i]),  
                backgroundColor: "rgba(0,0,255,0.5)",  
                type: 'bar',  
                yAxisID: 'y3',  
                borderRadius: 4,  
              },  
              {  
                label: "Pression (hPa)",  
                data: pressures,  
                borderColor: "gray",  
                borderDash: [5,5],  
                fill: false,  
                yAxisID: 'y4',  
                tension: 0.3,  
                pointRadius: 2,  
              }  
            ]  
          },  
          options: {  
            responsive: true,  
            interaction: { mode: 'index', intersect: false },  
            stacked: false,  
            scales: {  
              y1: {  
                type: 'linear',  
                display: true,  
                position: 'left',  
                title: { display: true, text: 'Temp√©rature (¬∞C)' },  
                min: Math.min(...temps) - 5,  
                max: Math.max(...temps) + 5,  
              },  
              y2: {  
                type: 'linear',  
                display: true,  
                position: 'right',  
                grid: { drawOnChartArea: false },  
                title: { display: true, text: 'Humidit√© (%)' },  
                min: 0, max: 100  
              },  
              y3: {  
                type: 'linear',  
                display: true,  
                position: 'right',  
                grid: { drawOnChartArea: false },  
                title: { display: true, text: 'Pr√©cipitations (mm)' },  
                min: 0  
              },  
              y4: {  
                type: 'linear',  
                display: true,  
                position: 'right',  
                grid: { drawOnChartArea: false },  
                title: { display: true, text: 'Pression (hPa)' },  
                min: Math.min(...pressures) - 10,  
                max: Math.max(...pressures) + 10  
              }  
            }  
          }  
        });  
    
        // Graphique vent (secondaire)  
        const ctxWind = document.getElementById("windChart").getContext("2d");  
        new Chart(ctxWind, {  
          type: 'bar',  
          data: {  
            labels,  
            datasets: [  
              {  
                label: 'Vent (km/h)',  
                data: winds,  
                backgroundColor: 'rgba(0, 123, 255, 0.7)',  
              }  
            ]  
          },  
          options: {  
            responsive: true,  
            scales: {  
              y: {  
                beginAtZero: true,  
                max: Math.max(...winds) + 10  
              }  
            },  
            plugins: {  
              tooltip: {  
                callbacks: {  
                  label: ctx => `${ctx.parsed.y} km/h (${degToCardinal(windDirs[ctx.dataIndex])})`  
                }  
              }  
            }  
          }  
        });  
    
      } catch (e) {  
        console.error("Erreur pr√©vision :", e);  
      }  
    }  
    
    // Chargement initial  
    async function init() {  
      await fetchWeather();  
      await fetchForecast();  
    }  
    
    init();  
  </script>  
</body>  
</html>  

<!-- Qualit√© de l'air en liste simple -->
<div id="air-quality-info" style="margin-top:10px; padding: 10px; background:#f0f8ff; border-radius:8px; max-width: 350px;">
  <h3>Qualit√© de l'air</h3>
  <ul style="list-style:none; padding-left:0; margin:0;">
    <li>PM2.5 : <span id="pm25"></span></li>
    <li>PM10 : <span id="pm10"></span></li>
    <li>O‚ÇÉ (ozone) : <span id="o3"></span></li>
    <li>NO‚ÇÇ : <span id="no2"></span></li>
    <li>SO‚ÇÇ : <span id="so2"></span></li>
    <li>CO : <span id="co"></span></li>
  </ul>
</div>

<!-- Phase lunaire sous m√©t√©o actuelle -->
<div id="lunar-phase" style="margin-top: 10px; font-size: 1.1em; display: flex; align-items: center; gap: 10px; max-width: 350px;">
  <span id="moon-icon" style="font-size: 40px;">üåë</span>
  <span id="moon-phase-text">Chargement phase lune...</span>
</div>

<script>
  // Interpr√©tations qualit√© air par polluant (valeurs ¬µg/m¬≥) - exemples
  function interpretPM25(val) {
    if(val <= 10) return "Excellente";
    if(val <= 20) return "Bonne";
    if(val <= 25) return "Moyenne";
    if(val <= 50) return "Mauvaise";
    return "Tr√®s mauvaise";
  }
  function interpretPM10(val) {
    if(val <= 20) return "Excellente";
    if(val <= 50) return "Bonne";
    if(val <= 90) return "Moyenne";
    if(val <= 180) return "Mauvaise";
    return "Tr√®s mauvaise";
  }
  function interpretO3(val) {
    if(val <= 60) return "Excellente";
    if(val <= 120) return "Bonne";
    if(val <= 180) return "Moyenne";
    if(val <= 240) return "Mauvaise";
    return "Tr√®s mauvaise";
  }
  function interpretNO2(val) {
    if(val <= 40) return "Excellente";
    if(val <= 90) return "Bonne";
    if(val <= 120) return "Moyenne";
    if(val <= 230) return "Mauvaise";
    return "Tr√®s mauvaise";
  }
  function interpretSO2(val) {
    if(val <= 20) return "Excellente";
    if(val <= 80) return "Bonne";
    if(val <= 250) return "Moyenne";
    if(val <= 500) return "Mauvaise";
    return "Tr√®s mauvaise";
  }
  function interpretCO(val) {
    if(val <= 4400) return "Excellente";
    if(val <= 9400) return "Bonne";
    if(val <= 12400) return "Moyenne";
    if(val <= 15400) return "Mauvaise";
    return "Tr√®s mauvaise";
  }

  // Phase lunaire (algorithme simple, 8 phases)
  function getMoonPhase(date = new Date()) {
    const lp = 2551443; // dur√©e cycle lunaire en secondes
    const newMoon = new Date(1970, 0, 7, 20, 35, 0);
    const phase = ((date.getTime() - newMoon.getTime()) / 1000) % lp;
    const phaseIndex = Math.floor((phase / lp) * 8);
    const phases = [
      { name: "Nouvelle lune", icon: "üåë" },
      { name: "Premier croissant", icon: "üåí" },
      { name: "Premier quartier", icon: "üåì" },
      { name: "Lune gibbeuse croissante", icon: "üåî" },
      { name: "Pleine lune", icon: "üåï" },
      { name: "Lune gibbeuse d√©croissante", icon: "üåñ" },
      { name: "Dernier quartier", icon: "üåó" },
      { name: "Dernier croissant", icon: "üåò" }
    ];
    return phases[phaseIndex];
  }

  // Met √† jour la phase lunaire sur la page
  function updateLunarPhase() {
    const moon = getMoonPhase();
    document.getElementById("moon-icon").textContent = moon.icon;
    document.getElementById("moon-phase-text").textContent = moon.name;
  }

  // Met √† jour l'affichage de la qualit√© de l'air
  function updateAirQualityDisplay(pollution) {
    document.getElementById('pm25').textContent = `${pollution.pm25} ¬µg/m¬≥ (${interpretPM25(pollution.pm25)})`;
    document.getElementById('pm10').textContent = `${pollution.pm10} ¬µg/m¬≥ (${interpretPM10(pollution.pm10)})`;
    document.getElementById('o3').textContent = `${pollution.o3} ¬µg/m¬≥ (${interpretO3(pollution.o3)})`;
    document.getElementById('no2').textContent = `${pollution.no2} ¬µg/m¬≥ (${interpretNO2(pollution.no2)})`;
    document.getElementById('so2').textContent = `${pollution.so2} ¬µg/m¬≥ (${interpretSO2(pollution.so2)})`;
    document.getElementById('co').textContent = `${pollution.co} ¬µg/m¬≥ (${interpretCO(pollution.co)})`;
  }

  // --- Fonction fetchWeather modifi√©e pour appeler les mises √† jour ---
  async function fetchWeather() {
    try {
      const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=${units}&lang=${lang}`);
      const data = await res.json();

      // ... ton code actuel de mise √† jour m√©t√©o ici ...

      // Mise √† jour qualit√© air
      const pollutionRes = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${data.coord.lat}&lon=${data.coord.lon}&appid=${apiKey}`);
      const pollutionDataRaw = await pollutionRes.json();
      const pollution = pollutionDataRaw.list[0].components;
      updateAirQualityDisplay(pollution);

      // Mise √† jour phase lunaire
      updateLunarPhase();

      // ... reste de ton code ...
    } catch (e) {
      console.error("Erreur m√©t√©o actuelle :", e);
      alert("Erreur lors de la r√©cup√©ration de la m√©t√©o actuelle.");
    }
  }

  // Garde fetchForecast et autres fonctions inchang√©es.

  // Appel initial
  fetchWeather();
  fetchForecast();

  // Optionnel : rafra√Æchir p√©riodiquement (exemple toutes les 15 minutes)
  setInterval(fetchWeather, 900000);
  setInterval(fetchForecast, 900000);
</script>
