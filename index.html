<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>M√©t√©o compl√®te Zimmersheim - avec Lune anim√©e & luminosit√© corrig√©e</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body, html {
    margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(to bottom, #87ceeb, #f0f8ff);
    color: #222;
    overflow-x: hidden;
  }
  #background-anim {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    z-index: -2;
    pointer-events: none;
    overflow: hidden;
  }
  /* Lune anim√©e (canvas) */
  #moon-canvas {
    position: fixed;
    top: 30px;
    right: 30px;
    width: 150px;
    height: 150px;
    z-index: -1;
    pointer-events: none;
  }
  /* Nuages anim√©s */
  .cloud {
    position: absolute;
    background: #fff;
    background: linear-gradient(to bottom, #f0f4f8, #cbd6e8);
    border-radius: 50px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    animation: cloudMove linear infinite;
    opacity: 0.8;
  }
  .cloud::before, .cloud::after {
    content: '';
    position: absolute;
    background: inherit;
    border-radius: 50px;
  }
  .cloud::before {
    width: 60px; height: 60px;
    top: -30px; left: 10px;
  }
  .cloud::after {
    width: 50px; height: 50px;
    top: -20px; left: 45px;
  }
  @keyframes cloudMove {
    0% { left: -150px; }
    100% { left: 110vw; }
  }
  /* Pluie anim√©e */
  .rain {
    position: absolute;
    width: 2px; height: 15px;
    background: rgba(0, 150, 255, 0.5);
    border-radius: 50%;
    animation: rainFall linear infinite;
  }
  @keyframes rainFall {
    0% { top: -20px; opacity: 1; }
    100% { top: 110vh; opacity: 0; }
  }
  /* Neige anim√©e */
  .snow {
    position: absolute;
    width: 8px; height: 8px;
    background: white;
    border-radius: 50%;
    filter: drop-shadow(0 0 1px #aaa);
    animation: snowFall linear infinite;
  }
  @keyframes snowFall {
    0% { top: -10px; opacity: 1; transform: translateX(0); }
    100% { top: 110vh; opacity: 0; transform: translateX(20px); }
  }
  #container {
    display: flex; max-width: 1200px; margin: 30px auto; gap: 20px;
    flex-wrap: wrap;
  }
  #left-panel {
    flex: 1 1 350px;
    background: rgba(255,255,255,0.9);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 0 30px rgba(0,0,0,0.1);
    user-select: none;
  }
  #right-panel {
    flex: 1 1 600px;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 0 30px rgba(0,0,0,0.1);
  }
  #right-panel iframe {
    width: 100%; height: 300px; border: none;
  }
  h1, h2 {
    margin-bottom: 15px; user-select: none;
    text-align: center;
  }
  .info-row {
    margin: 10px 0;
    font-size: 1.1rem;
    display: flex; align-items: center; justify-content: space-between;
  }
  .label {
    font-weight: 700;
    color: #555;
  }
  #condition-icon {
    display: block;
    margin: 10px auto;
    width: 100px; height: 100px;
  }
  /* Fl√®che direction vent */
  #wind-arrow {
    display: inline-block;
    width: 24px; height: 24px;
    margin-left: 8px;
    vertical-align: middle;
    transition: transform 0.3s ease;
  }
  /* Graphiques */
  section.chart-section {
    background: rgba(255,255,255,0.95);
    margin: 30px auto;
    max-width: 1200px;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 0 30px rgba(0,0,0,0.08);
    user-select: none;
  }
  canvas {
    width: 100% !important;
    max-height: 400px !important;
  }
</style>
</head>
<body>

<div id="background-anim"></div>
<canvas id="moon-canvas" width="150" height="150"></canvas>

<div id="container">
  <div id="left-panel">
    <h1>M√©t√©o actuelle - Zimmersheim</h1>
    <img id="condition-icon" src="" alt="Ic√¥ne m√©t√©o" />
    <div class="info-row"><span class="label">Condition :</span> <span id="description"></span></div>
    <div class="info-row"><span class="label">Temp√©rature :</span> <span id="temp"></span> ¬∞C</div>
    <div class="info-row"><span class="label">Humidit√© :</span> <span id="humidity"></span> %</div>
    <div class="info-row"><span class="label">Pr√©cipitations (1h) :</span> <span id="precip"></span></div>
    <div class="info-row"><span class="label">Pression :</span> <span id="pressure"></span> hPa</div>
    <div class="info-row">
      <span class="label">Vent :</span> 
      <span id="wind"></span> km/h
      <svg id="wind-arrow" viewBox="0 0 24 24" fill="none" stroke="#0077cc" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" >
        <line x1="12" y1="19" x2="12" y2="5"></line>
        <polyline points="5 12 12 5 19 12"></polyline>
      </svg>
    </div>
    <div class="info-row">
      <span class="label">Direction vent :</span> 
      <span id="wind-dir"></span>
    </div>
    <div class="info-row"><span class="label">Lever du soleil :</span> <span id="sunrise"></span></div>
    <div class="info-row"><span class="label">Coucher du soleil :</span> <span id="sunset"></span></div>
    <div class="info-row"><span class="label">Luminosit√© corrig√©e :</span> <span id="luminosity"></span> %</div>
  </div>

  <div id="right-panel">
    <h2 style="text-align:center; padding: 10px 0;">Vue satellite - Zimmersheim</h2>
    <iframe
      id="map-frame"
      src="https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d2777.8758572121094!2d7.337325815711999!3d47.7745615792057!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0!3m2!1sfr!2sfr!4v1691246400000!5m2!1sfr!2sfr&layer=c"
      allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
    </iframe>
  </div>
</div>

<section class="chart-section">
  <h2>üìä Graphique principal</h2>
  <canvas id="mainChart"></canvas>
</section>

<section class="chart-section">
  <h2>üìä Graphique secondaire (vent)</h2>
  <canvas id="windChart"></canvas>
</section>

<script>
// API et param√®tres
const apiKey = "f59e1314a26b162f41dabbc7bb2b7719"; // Mets ta cl√© API ici !
const city = "Zimmersheim,fr";
const units = "metric";
const lang = "fr";

const conditionIcon = document.getElementById('condition-icon');
const windArrow = document.getElementById('wind-arrow');
const windDirSpan = document.getElementById('wind-dir');
const luminositySpan = document.getElementById('luminosity');

// Convertit degr√©s en direction cardinales
function degToCardinal(deg) {
  if (deg == null) return "N/A";
  const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE',
                      'S', 'SSO', 'SO', 'OSO', 'O', 'ONO', 'NO', 'NNO'];
  const index = Math.floor(((deg + 11.25) % 360) / 22.5);
  return directions[index];
}
// Format heure HH:MM locale
function formatTime(unixTimestamp) {
  const d = new Date(unixTimestamp * 1000);
  return d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
}
// Vide enfants d'un √©l√©ment
function clearChildren(parent) {
  while (parent.firstChild) parent.removeChild(parent.firstChild);
}

// Cr√©e nuages anim√©s
function createClouds() {
  const container = document.getElementById('background-anim');
  clearChildren(container);
  for (let i=0; i<5; i++) {
    const cloud = document.createElement('div');
    cloud.className = 'cloud';
    cloud.style.top = (20 + i*50) + 'px';
    cloud.style.width = (80 + Math.random()*60) + 'px';
    cloud.style.height = '50px';
    cloud.style.animationDuration = (30 + Math.random()*40) + 's';
    cloud.style.animationDelay = (-Math.random()*60) + 's';
    container.appendChild(cloud);
  }
}
// Cr√©e pluie anim√©e
function createRain() {
  const container = document.getElementById('background-anim');
  clearChildren(container);
  for (let i=0; i<50; i++) {
    const drop = document.createElement('div');
    drop.className = 'rain';
    drop.style.left = (Math.random() * window.innerWidth) + 'px';
    drop.style.animationDuration = (0.5 + Math.random()*0.5) + 's';
    drop.style.animationDelay = (-Math.random()*1) + 's';
    container.appendChild(drop);
  }
}
// Cr√©e neige anim√©e
function createSnow() {
  const container = document.getElementById('background-anim');
  clearChildren(container);
  for (let i=0; i<40; i++) {
    const flake = document.createElement('div');
    flake.className = 'snow';
    flake.style.left = (Math.random() * window.innerWidth) + 'px';
    flake.style.animationDuration = (3 + Math.random()*4) + 's';
    flake.style.animationDelay = (-Math.random()*7) + 's';
    container.appendChild(flake);
  }
}
// Supprime animations
function clearAnimations() {
  const container = document.getElementById('background-anim');
  clearChildren(container);
}

// ---------- LUNE ANIM√âE -----------
// Dessine la lune avec phase (0 = nouvelle lune, 1 = pleine lune)
// Inspir√© de https://stackoverflow.com/questions/26450368/draw-moon-phases-with-html5-canvas
function drawMoon(ctx, radius, phase) {
  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

  const centerX = ctx.canvas.width / 2;
  const centerY = ctx.canvas.height / 2;

  ctx.fillStyle = '#FFFDD0'; // couleur lune
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
  ctx.fill();

  ctx.globalCompositeOperation = 'destination-out';
  ctx.beginPath();

  // D√©calage lune ombre
  const offset = radius * 2 * (phase < 0.5 ? phase * 2 : (1 - phase) * 2);
  if (phase < 0.5) {
    // Croissant d√©croissant
    ctx.arc(centerX + offset, centerY, radius, 0, 2 * Math.PI);
  } else {
    // Croissant croissant
    ctx.arc(centerX - offset, centerY, radius, 0, 2 * Math.PI);
  }
  ctx.fill();
  ctx.globalCompositeOperation = 'source-over';

  // Ajout l√©ger halo
  const gradient = ctx.createRadialGradient(centerX, centerY, radius * 0.8, centerX, centerY, radius * 1.4);
  gradient.addColorStop(0, 'rgba(255, 255, 224, 0.7)');
  gradient.addColorStop(1, 'transparent');
  ctx.fillStyle = gradient;
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius * 1.4, 0, 2 * Math.PI);
  ctx.fill();
}

// Calcule phase de lune en fraction [0,1] selon date UTC
// 0 = nouvelle lune, 0.5 = pleine lune
function getMoonPhase(date = new Date()) {
  // R√©f√©rence nouvelle lune : 6 janvier 2000 √† 18:14 UTC
  const ref = new Date(Date.UTC(2000, 0, 6, 18, 14));
  const lunation = 29.530588853; // dur√©e lunaison en jours
  const diff = (date.getTime() - ref.getTime()) / (1000 * 60 * 60 * 24);
  let phase = (diff % lunation) / lunation;
  if (phase < 0) phase += 1;
  return phase;
}

// Animateur lune (rafra√Æchit toutes les 2 secondes)
function animateMoon() {
  const canvas = document.getElementById('moon-canvas');
  const ctx = canvas.getContext('2d');
  const radius = canvas.width / 2 * 0.9;
  const phase = getMoonPhase(new Date());
  drawMoon(ctx, radius, phase);
  setTimeout(animateMoon, 2000);
}

// ---------- FETCH M√âT√âO ACTUELLE ----------
async function fetchWeather() {
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=${units}&lang=${lang}`);
    const data = await res.json();

    // Mise √† jour infos basiques
    document.getElementById("description").textContent = data.weather[0].description;
    document.getElementById("temp").textContent = Math.round(data.main.temp);
    document.getElementById("humidity").textContent = data.main.humidity;
    let precip = 0;
    if(data.rain && data.rain["1h"]) precip += data.rain["1h"];
    if(data.snow && data.snow["1h"]) precip += data.snow["1h"];
    document.getElementById("precip").textContent = precip > 0 ? precip.toFixed(1) + " mm" : "Aucune";
    document.getElementById("pressure").textContent = data.main.pressure;
    document.getElementById("wind").textContent = Math.round(data.wind.speed * 3.6);

    // Direction vent + rotation fl√®che
    const deg = data.wind.deg;
    const cardinal = degToCardinal(deg);
    windDirSpan.textContent = `${cardinal} (${deg}¬∞)`;
    windArrow.style.transform = `rotate(${deg}deg)`;

    // Lever / coucher soleil
    document.getElementById("sunrise").textContent = formatTime(data.sys.sunrise);
    document.getElementById("sunset").textContent = formatTime(data.sys.sunset);

    // Icone condition m√©t√©o
    conditionIcon.src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@4x.png`;
    conditionIcon.alt = data.weather[0].description;

    // Fond anim√© m√©t√©o
    const main = data.weather[0].main.toLowerCase();
    if(main.includes("rain")) createRain();
    else if(main.includes("snow")) createSnow();
    else if(main.includes("cloud")) createClouds();
    else clearAnimations();

    // Luminosit√© corrig√©e par n√©bulosit√©
    // OpenWeatherMap current cloudiness (0-100%)
    const cloudiness = data.clouds?.all ?? 0;
    // Luminosit√© approx = luminosit√© solaire * (1 - n√©bulosit√©/100)
    // Utilisation proxy : luminosit√© = max(0, 100 - n√©bulosit√©)
    const rawLuminosity = 100; // On pourrait avoir un vrai capteur si besoin
    const correctedLum = Math.max(0, rawLuminosity * (1 - cloudiness/100));
    luminositySpan.textContent = correctedLum.toFixed(0);

  } catch (e) {
    console.error("Erreur m√©t√©o actuelle :", e);
    alert("Erreur lors de la r√©cup√©ration de la m√©t√©o actuelle.");
  }
}

// ------------- CHART.JS (exemple simple) -------------
const mainChartCtx = document.getElementById('mainChart').getContext('2d');
const windChartCtx = document.getElementById('windChart').getContext('2d');
let mainChart, windChart;

async function fetchForecastAndDrawCharts() {
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=${units}&lang=${lang}`);
    const forecast = await res.json();

    // Pr√©paration donn√©es graphiques
    const labels = [];
    const temps = [];
    const humidities = [];
    const windSpeeds = [];
    const windDirs = [];

    forecast.list.forEach(item => {
      labels.push(new Date(item.dt * 1000).toLocaleString('fr-FR', {hour:'2-digit', day:'2-digit', month:'2-digit'}));
      temps.push(item.main.temp);
      humidities.push(item.main.humidity);
      windSpeeds.push(item.wind.speed * 3.6);
      windDirs.push(item.wind.deg);
    });

    // Graphique principal : temp + humidit√©
    if(mainChart) mainChart.destroy();
    mainChart = new Chart(mainChartCtx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Temp√©rature (¬∞C)',
            data: temps,
            borderColor: 'rgba(255, 99, 132, 0.8)',
            backgroundColor: 'rgba(255, 99, 132, 0.3)',
            yAxisID: 'y',
          },
          {
            label: 'Humidit√© (%)',
            data: humidities,
            borderColor: 'rgba(54, 162, 235, 0.8)',
            backgroundColor: 'rgba(54, 162, 235, 0.3)',
            yAxisID: 'y1',
          },
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        stacked: false,
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            min: 0,
            max: 40,
            title: { display: true, text: 'Temp√©rature (¬∞C)' }
          },
          y1: {
            type: 'linear',
            position: 'right',
            min: 0,
            max: 100,
            title: { display: true, text: 'Humidit√© (%)' },
            grid: { drawOnChartArea: false }
          }
        },
        plugins: {
          legend: { position: 'top' },
          tooltip: { enabled: true }
        }
      }
    });

    // Graphique vent : vitesse + direction (√©chelle direction en texte)
    if(windChart) windChart.destroy();
    windChart = new Chart(windChartCtx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Vent (km/h)',
          data: windSpeeds,
          backgroundColor: 'rgba(0, 123, 255, 0.7)'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: ctx => {
                const deg = windDirs[ctx.dataIndex];
                return `Vitesse: ${ctx.parsed.y.toFixed(1)} km/h, Dir: ${degToCardinal(deg)} (${deg}¬∞)`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: { display: true, text: 'Vitesse du vent (km/h)' }
          },
          x: {
            ticks: {
              callback: function(value, index) {
                // Ajout des directions cardinales en dessous
                const deg = windDirs[index];
                return this.getLabelForValue(value) + '\n' + degToCardinal(deg);
              }
            }
          }
        }
      }
    });

  } catch (e) {
    console.error("Erreur r√©cup√©ration pr√©visions :", e);
  }
}

// ---------- Initialisation ----------
async function init() {
  await fetchWeather();
  await fetchForecastAndDrawCharts();
  animateMoon();

  // Actualisation toutes les 10 minutes
  setInterval(async () => {
    await fetchWeather();
    await fetchForecastAndDrawCharts();
  }, 600000);
}

window.onload = init;

</script>

</body>
</html>
