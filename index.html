<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>M√©t√©o compl√®te Zimmersheim</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body, html {
    margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(to bottom, #87ceeb, #f0f8ff);
    color: #222;
  }
  #container {
    display: flex; max-width: 1200px; margin: 30px auto; gap: 20px;
    flex-wrap: wrap;
  }
  #left-panel {
    flex: 1 1 350px;
    background: rgba(255,255,255,0.9);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 0 30px rgba(0,0,0,0.1);
    user-select: none;
  }
  #right-panel {
    flex: 1 1 600px;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 0 30px rgba(0,0,0,0.1);
  }
  #right-panel iframe {
    width: 100%; height: 300px; border: none;
  }
  h1, h2 {
    margin-bottom: 15px; user-select: none;
    text-align: center;
  }
  .info-row {
    margin: 10px 0;
    font-size: 1.1rem;
  }
  .label {
    font-weight: 700;
    color: #555;
  }
  #condition-icon {
    display: block;
    margin: 10px auto;
    width: 100px; height: 100px;
  }
  section.chart-section {
    background: rgba(255,255,255,0.95);
    margin: 30px auto;
    max-width: 1200px;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 0 30px rgba(0,0,0,0.08);
    user-select: none;
  }
  canvas {
    width: 100% !important;
    max-height: 400px !important;
  }
</style>
</head>
<body>

<div id="container">
  <div id="left-panel">
    <h1>M√©t√©o actuelle - Zimmersheim</h1>
    <img id="condition-icon" src="" alt="Ic√¥ne m√©t√©o" />
    <div class="info-row"><span class="label">Condition :</span> <span id="description"></span></div>
    <div class="info-row"><span class="label">Temp√©rature :</span> <span id="temp"></span> ¬∞C</div>
    <div class="info-row"><span class="label">Humidit√© :</span> <span id="humidity"></span> %</div>
    <div class="info-row"><span class="label">Pr√©cipitations (1h) :</span> <span id="precip"></span></div>
    <div class="info-row"><span class="label">Pression :</span> <span id="pressure"></span> hPa</div>
    <div class="info-row"><span class="label">Vent :</span> <span id="wind"></span> km/h</div>
    <div class="info-row"><span class="label">Direction vent :</span> <span id="wind-dir"></span></div>
    <div class="info-row"><span class="label">Lever du soleil :</span> <span id="sunrise"></span></div>
    <div class="info-row"><span class="label">Coucher du soleil :</span> <span id="sunset"></span></div>
  </div>

  <div id="right-panel">
    <h2 style="text-align:center; padding: 10px 0;">Vue a√©rienne - Zimmersheim</h2>
    <!-- Google Maps aerial, modifiable ici -->
    <iframe 
      id="map-frame"
      src="https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d2777.8758572121094!2d7.337325815711999!3d47.7745615792057!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0!3m2!1sfr!2sfr!4v1691246400000!5m2!1sfr!2sfr" 
      allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
    </iframe>
  </div>
</div>

<section class="chart-section">
  <h2>üìä Graphique principal</h2>
  <canvas id="mainChart"></canvas>
</section>

<section class="chart-section">
  <h2>üìä Graphique secondaire (vent)</h2>
  <canvas id="windChart"></canvas>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const apiKey = "f59e1314a26b162f41dabbc7bb2b7719"; // Remplace par ta cl√© OpenWeatherMap
  const city = "Zimmersheim,fr";
  const units = "metric";
  const lang = "fr";

  const conditionIcon = document.getElementById('condition-icon');

  function degToCardinal(deg) {
    if (deg == null) return "N/A";
    const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE',
                        'S', 'SSO', 'SO', 'OSO', 'O', 'ONO', 'NO', 'NNO'];
    const index = Math.floor(((deg + 11.25) % 360) / 22.5);
    return directions[index];
  }

  function formatTime(unixTimestamp) {
    const d = new Date(unixTimestamp * 1000);
    return d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  }

  async function fetchWeather() {
    try {
      const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=${units}&lang=${lang}`);
      const data = await res.json();

      document.getElementById("description").textContent = data.weather[0].description;
      document.getElementById("temp").textContent = Math.round(data.main.temp);
      document.getElementById("humidity").textContent = data.main.humidity;
      // Pluie + neige 1h cumul√©e
      let precip = 0;
      if(data.rain && data.rain["1h"]) precip += data.rain["1h"];
      if(data.snow && data.snow["1h"]) precip += data.snow["1h"];
      document.getElementById("precip").textContent = precip > 0 ? precip.toFixed(1) + " mm" : "Aucune";

      document.getElementById("pressure").textContent = data.main.pressure;
      document.getElementById("wind").textContent = Math.round(data.wind.speed * 3.6);
      document.getElementById("wind-dir").textContent = degToCardinal(data.wind.deg);

      document.getElementById("sunrise").textContent = formatTime(data.sys.sunrise);
      document.getElementById("sunset").textContent = formatTime(data.sys.sunset);

      conditionIcon.src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@4x.png`;
      conditionIcon.alt = data.weather[0].description;

    } catch (e) {
      console.error("Erreur m√©t√©o actuelle :", e);
      alert("Erreur lors de la r√©cup√©ration de la m√©t√©o actuelle.");
    }
  }

  async function fetchForecast() {
    try {
      const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=${units}&lang=${lang}`);
      const data = await res.json();

      const labels = [];
      const temps = [];
      const humidities = [];
      const pressures = [];
      const rains = [];
      const snows = [];
      const winds = [];
      const windDirs = [];

      data.list.forEach(item => {
        const date = new Date(item.dt * 1000);
        const label = date.toLocaleString('fr-FR', { weekday: 'short', hour: '2-digit', minute: '2-digit' });
        labels.push(label);

        temps.push(item.main.temp);
        humidities.push(item.main.humidity);
        pressures.push(item.main.pressure);
        rains.push(item.rain?.["3h"] || 0);
        snows.push(item.snow?.["3h"] || 0);
        winds.push(item.wind.speed * 3.6);
        windDirs.push(item.wind.deg);
      });

      // Graphique principal
      const ctxMain = document.getElementById("mainChart").getContext("2d");
      new Chart(ctxMain, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: "Temp√©rature (¬∞C)",
              data: temps,
              borderColor: "red",
              backgroundColor: "rgba(255,0,0,0.2)",
              yAxisID: 'y1',
              tension: 0.3,
              fill: true,
              pointRadius: 3,
            },
            {
              label: "Humidit√© (%)",
              data: humidities,
              borderColor: "blue",
              backgroundColor: "rgba(0,0,255,0.2)",
              yAxisID: 'y2',
              tension: 0.3,
              fill: true,
              pointRadius: 3,
            },
            {
              label: "Pluie + Neige (mm)",
              data: rains.map((r,i) => r + snows[i]),
              backgroundColor: "rgba(0,0,255,0.5)",
              type: 'bar',
              yAxisID: 'y3',
              borderRadius: 4,
            },
            {
              label: "Pression (hPa)",
              data: pressures,
              borderColor: "gray",
              borderDash: [5,5],
              fill: false,
              yAxisID: 'y4',
              tension: 0.3,
              pointRadius: 2,
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          stacked: false,
          scales: {
            y1: {
              type: 'linear',
              position: 'left',
              title: { display: true, text: 'Temp√©rature (¬∞C)' },
              grid: { drawOnChartArea: true },
              beginAtZero: false,
            },
            y2: {
              type: 'linear',
              position: 'right',
              offset: true,
              title: { display: true, text: 'Humidit√© (%)' },
              grid: { drawOnChartArea: false },
              beginAtZero: true,
              max: 100,
            },
            y3: {
              type: 'linear',
              position: 'right',
              offset: true,
              title: { display: true, text: 'Pr√©cipitations (mm)' },
              grid: { drawOnChartArea: false },
              beginAtZero: true,
            },
            y4: {
              type: 'linear',
              position: 'left',
              offset: true,
              title: { display: true, text: 'Pression (hPa)' },
              grid: { drawOnChartArea: false },
              beginAtZero: false,
            }
          },
          plugins: {
            legend: { position: 'top', labels: { boxWidth: 12, padding: 10 } },
            tooltip: { enabled: true, mode: 'nearest', intersect: false }
          }
        }
      });

      // Graphique secondaire - vent vitesse + direction (direction affich√©e en pointill√©s)
      const ctxWind = document.getElementById("windChart").getContext("2d");
      new Chart(ctxWind, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: "Vitesse du vent (km/h)",
              data: winds,
              borderColor: "#1f8ef1",
              backgroundColor: "rgba(31, 142, 241, 0.3)",
              yAxisID: 'y1',
              tension: 0.3,
              fill: true,
              pointRadius: 3,
            },
            {
              label: "Direction du vent (¬∞)",
              data: windDirs,
              borderColor: "#555",
              borderDash: [6,4],
              yAxisID: 'y2',
              fill: false,
              tension: 0.3,
              pointRadius: 2,
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          stacked: false,
          scales: {
            y1: {
              type: 'linear',
              position: 'left',
              title: { display: true, text: 'Vitesse (km/h)' },
              beginAtZero: true,
            },
            y2: {
              type: 'linear',
              position: 'right',
              offset: true,
              title: { display: true, text: 'Direction (¬∞)' },
              beginAtZero: false,
              min: 0,
              max: 360,
              grid: { drawOnChartArea: false },
            }
          },
          plugins: {
            legend: { position: 'top', labels: { boxWidth: 12, padding: 10 } },
            tooltip: { enabled: true, mode: 'nearest', intersect: false }
          }
        }
      });

    } catch (e) {
      console.error("Erreur r√©cup√©ration pr√©visions :", e);
      alert("Erreur lors de la r√©cup√©ration des pr√©visions m√©t√©o.");
    }
  }

  fetchWeather();
  fetchForecast();

</script>
</body>
</html>
