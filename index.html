<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>M√©t√©o compl√®te Zimmersheim - am√©lior√©e</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body, html {
    margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(to bottom, #87ceeb, #f0f8ff);
    color: #222;
    overflow-x: hidden;
  }
  #background-anim {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    z-index: -1;
    pointer-events: none;
    overflow: hidden;
    background: radial-gradient(ellipse at center, #000428 0%, #004e92 70%, #87ceeb 100%);
  }
  .cloud {
    position: absolute;
    background: linear-gradient(to bottom, #f0f4f8, #cbd6e8);
    border-radius: 50px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    animation: cloudMove linear infinite;
    opacity: 0.8;
  }
  .cloud::before, .cloud::after {
    content: '';
    position: absolute;
    background: inherit;
    border-radius: 50px;
  }
  .cloud::before {
    width: 60px; height: 60px;
    top: -30px; left: 10px;
  }
  .cloud::after {
    width: 50px; height: 50px;
    top: -20px; left: 45px;
  }
  @keyframes cloudMove {
    0% { left: -150px; }
    100% { left: 110vw; }
  }
  .rain {
    position: absolute;
    width: 2px; height: 15px;
    background: rgba(0, 150, 255, 0.5);
    border-radius: 50%;
    animation: rainFall linear infinite;
  }
  @keyframes rainFall {
    0% { top: -20px; opacity: 1; }
    100% { top: 110vh; opacity: 0; }
  }
  .snow {
    position: absolute;
    width: 8px; height: 8px;
    background: white;
    border-radius: 50%;
    filter: drop-shadow(0 0 1px #aaa);
    animation: snowFall linear infinite;
  }
  @keyframes snowFall {
    0% { top: -10px; opacity: 1; transform: translateX(0); }
    100% { top: 110vh; opacity: 0; transform: translateX(20px); }
  }
  #container {
    display: flex; max-width: 1200px; margin: 30px auto; gap: 20px;
    flex-wrap: wrap;
  }
  #left-panel {
    flex: 1 1 350px;
    background: rgba(255,255,255,0.9);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 0 30px rgba(0,0,0,0.1);
    user-select: none;
  }
  #right-panel {
    flex: 1 1 600px;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 0 30px rgba(0,0,0,0.1);
    background: rgba(255,255,255,0.9);
    padding: 15px;
  }
  h1, h2 {
    margin-bottom: 15px;
    user-select: none;
    text-align: center;
  }
  .info-row {
    margin: 10px 0;
    font-size: 1.1rem;
    display: flex; align-items: center; justify-content: space-between;
  }
  .label {
    font-weight: 700;
    color: #555;
  }
  #condition-icon {
    display: block;
    margin: 10px auto;
    width: 100px; height: 100px;
  }
  #wind-arrow {
    display: inline-block;
    width: 24px; height: 24px;
    margin-left: 8px;
    vertical-align: middle;
    transition: transform 0.3s ease;
  }
  section.chart-section {
    background: rgba(255,255,255,0.95);
    margin: 30px auto;
    max-width: 1200px;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 0 30px rgba(0,0,0,0.08);
    user-select: none;
  }
  canvas {
    width: 100% !important;
    max-height: 400px !important;
  }
  /* Qualit√© de l'air panel */
  #airQualityPanel {
    margin-top: 20px;
  }
  #airQualityList {
    list-style: none;
    padding-left: 0;
    font-size: 1rem;
    color: #333;
  }
  #airQualityList li {
    margin-bottom: 5px;
  }
  /* Phases lune et fond √©toil√© */
  #moon-canvas {
    position: fixed;
    top: 10px; right: 10px;
    width: 120px; height: 120px;
    pointer-events: none;
    z-index: 10;
  }
</style>
</head>
<body>
<div id="background-anim"></div>
<canvas id="moon-canvas" width="120" height="120"></canvas>

<div id="container">
  <div id="left-panel">
    <h1>M√©t√©o actuelle - Zimmersheim</h1>
    <img id="condition-icon" src="" alt="Ic√¥ne m√©t√©o" />
    <div class="info-row"><span class="label">Condition :</span> <span id="description"></span></div>
    <div class="info-row"><span class="label">Temp√©rature :</span> <span id="temp"></span> ¬∞C</div>
    <div class="info-row"><span class="label">Humidit√© :</span> <span id="humidity"></span> %</div>
    <div class="info-row"><span class="label">Pr√©cipitations (1h) :</span> <span id="precip"></span></div>
    <div class="info-row"><span class="label">Pression :</span> <span id="pressure"></span> hPa</div>
    <div class="info-row">
      <span class="label">Vent :</span>
      <span id="wind"></span> km/h
      <svg id="wind-arrow" viewBox="0 0 24 24" fill="none" stroke="#0077cc" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" >
        <line x1="12" y1="19" x2="12" y2="5"></line>
        <polyline points="5 12 12 5 19 12"></polyline>
      </svg>
    </div>
    <div class="info-row">
      <span class="label">Direction vent :</span>
      <span id="wind-dir"></span>
    </div>
    <div class="info-row"><span class="label">Lever du soleil :</span> <span id="sunrise"></span></div>
    <div class="info-row"><span class="label">Coucher du soleil :</span> <span id="sunset"></span></div>
  </div>

  <div id="right-panel">
    <h2>Qualit√© de l'air - Zimmersheim</h2>
    <ul id="airQualityList"></ul>
    <canvas id="airChart" width="400" height="200"></canvas>
  </div>
</div>

<section class="chart-section">
  <h2>üìä Graphique principal (5 jours)</h2>
  <canvas id="mainChart"></canvas>
</section>

<section class="chart-section">
  <h2>üìä Graphique secondaire √©tendu (vent, luminosit√©, UV)</h2>
  <canvas id="windChart"></canvas>
</section>

<script>
const apiKey = "f59e1314a26b162f41dabbc7bb2b7719"; // ta cl√© OpenWeatherMap
const city = "Zimmersheim,fr";
const units = "metric";
const lang = "fr";

const conditionIcon = document.getElementById('condition-icon');
const windArrow = document.getElementById('wind-arrow');
const windDirSpan = document.getElementById('wind-dir');
const moonCanvas = document.getElementById('moon-canvas');
const moonCtx = moonCanvas.getContext('2d');

let mainChartInstance = null;
let windChartInstance = null;
let airChartInstance = null;

function degToCardinal(deg) {
  if (deg == null) return "N/A";
  const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE',
                      'S', 'SSO', 'SO', 'OSO', 'O', 'ONO', 'NO', 'NNO'];
  const index = Math.floor(((deg + 11.25) % 360) / 22.5);
  return directions[index];
}

function formatTime(unixTimestamp) {
  const d = new Date(unixTimestamp * 1000);
  return d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
}

function clearChildren(parent) {
  while (parent.firstChild) parent.removeChild(parent.firstChild);
}

function createClouds() {
  const container = document.getElementById('background-anim');
  clearChildren(container);
  for (let i=0; i<5; i++) {
    const cloud = document.createElement('div');
    cloud.className = 'cloud';
    cloud.style.top = (20 + i*50) + 'px';
    cloud.style.width = (80 + Math.random()*60) + 'px';
    cloud.style.height = '50px';
    cloud.style.animationDuration = (30 + Math.random()*40) + 's';
    cloud.style.animationDelay = (-Math.random()*60) + 's';
    container.appendChild(cloud);
  }
}

function createRain() {
  const container = document.getElementById('background-anim');
  clearChildren(container);
  for (let i=0; i<50; i++) {
    const drop = document.createElement('div');
    drop.className = 'rain';
    drop.style.left = (Math.random() * window.innerWidth) + 'px';
    drop.style.animationDuration = (0.5 + Math.random()*0.5) + 's';
    drop.style.animationDelay = (-Math.random()*1) + 's';
    container.appendChild(drop);
  }
}

function createSnow() {
  const container = document.getElementById('background-anim');
  clearChildren(container);
  for (let i=0; i<40; i++) {
    const flake = document.createElement('div');
    flake.className = 'snow';
    flake.style.left = (Math.random() * window.innerWidth) + 'px';
    flake.style.animationDuration = (3 + Math.random()*4) + 's';
    flake.style.animationDelay = (-Math.random()*7) + 's';
    container.appendChild(flake);
  }
}

function clearAnimations() {
  const container = document.getElementById('background-anim');
  clearChildren(container);
}

function drawMoon(phase) {
  // phase entre 0 et 1 : 0 = nouvelle lune, 0.5 = pleine lune, 1 = nouvelle lune
  const ctx = moonCtx;
  const width = moonCanvas.width;
  const height = moonCanvas.height;
  ctx.clearRect(0, 0, width, height);

  ctx.fillStyle = '#222';
  ctx.beginPath();
  ctx.arc(width/2, height/2, width/2 - 5, 0, 2 * Math.PI);
  ctx.fill();

  ctx.fillStyle = '#eee';
  ctx.beginPath();

  if (phase < 0.5) {
    // Croissant
    const k = phase * 4;
    ctx.ellipse(width/2 + (width/4)*k, height/2, width/2 - 5, height/2 - 5, 0, Math.PI/2, 3*Math.PI/2);
  } else {
    // D√©croissant
    const k = (1 - phase) * 4;
    ctx.ellipse(width/2 - (width/4)*k, height/2, width/2 - 5, height/2 - 5, 0, 3*Math.PI/2, Math.PI/2);
  }
  ctx.fill();
}

async function fetchWeather() {
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=${units}&lang=${lang}`);
    const data = await res.json();

    document.getElementById("description").textContent = data.weather[0].description;
    document.getElementById("temp").textContent = Math.round(data.main.temp);
    document.getElementById("humidity").textContent = data.main.humidity;

    let precip = 0;
    if(data.rain && data.rain["1h"]) precip += data.rain["1h"];
    if(data.snow && data.snow["1h"]) precip += data.snow["1h"];
    document.getElementById("precip").textContent = precip > 0 ? precip.toFixed(1) + " mm" : "Aucune";

    document.getElementById("pressure").textContent = data.main.pressure;
    document.getElementById("wind").textContent = Math.round(data.wind.speed * 3.6);

    const deg = data.wind.deg;
    const cardinal = degToCardinal(deg);
    windDirSpan.textContent = `${cardinal} (${deg}¬∞)`;
    windArrow.style.transform = `rotate(${deg}deg)`;

    document.getElementById("sunrise").textContent = formatTime(data.sys.sunrise);
    document.getElementById("sunset").textContent = formatTime(data.sys.sunset);

    conditionIcon.src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@4x.png`;
    conditionIcon.alt = data.weather[0].description;

    const main = data.weather[0].main.toLowerCase();
    if(main.includes("rain")) createRain();
    else if(main.includes("snow")) createSnow();
    else if(main.includes("cloud")) createClouds();
    else clearAnimations();

    return data;
  } catch (e) {
    console.error("Erreur m√©t√©o actuelle :", e);
    alert("Erreur lors de la r√©cup√©ration de la m√©t√©o actuelle.");
    return null;
  }
}

<script>
function isNight(nowUnix, sunriseUnix, sunsetUnix) {
  return nowUnix < sunriseUnix || nowUnix > sunsetUnix;
}

function calculateMoonPhase(date) {
  // Algorithme simple pour phase lunaire (0 √† 1)
  const synodicMonth = 29.53058867;
  const knownNewMoon = new Date(Date.UTC(2000,0,6,18,14)); // known new moon date
  const diff = (date.getTime() - knownNewMoon.getTime()) / 1000 / 86400;
  const phase = (diff % synodicMonth) / synodicMonth;
  return phase < 0 ? phase + 1 : phase;
}

async function fetchForecast() {
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=${units}&lang=${lang}`);
    const data = await res.json();

    const labels = [];
    const temps = [];
    const humidities = [];
    const pressures = [];
    const rains = [];
    const snows = [];
    const winds = [];
    const windDirs = [];
    const luminosities = [];
    const uvs = [];
    const timestamps = [];

    data.list.forEach(item => {
      const date = new Date(item.dt * 1000);
      const label = date.toLocaleString('fr-FR', { weekday: 'short', hour: '2-digit', minute: '2-digit' });
      labels.push(label);

      temps.push(item.main.temp);
      humidities.push(item.main.humidity);
      pressures.push(item.main.pressure);
      rains.push(item.rain?.["3h"] || 0);
      snows.push(item.snow?.["3h"] || 0);
      winds.push(item.wind.speed * 3.6);
      windDirs.push(item.wind.deg);
      timestamps.push(item.dt);

      // Luminosit√© brute estim√©e (en %)
      // On simule la luminosit√© selon l'heure (par exemple)
      // Ou on attend l‚ÄôAPI UV s√©par√©e, on mettra √† jour apr√®s
      luminosities.push(0); // placeholder
      uvs.push(0); // placeholder
    });

    // Appel API UV pour Zimmersheim (coordonn√©es fixes)
    const lat = data.city.coord.lat;
    const lon = data.city.coord.lon;
    const nowUnix = Math.floor(Date.now()/1000);

    // Fetch UV index for current day (en OpenWeatherMap OneCall API)
    const uvRes = await fetch(`https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${lon}&exclude=minutely,hourly,daily,alerts&appid=${apiKey}`);
    const uvData = await uvRes.json();
    const uvIndex = uvData.current.uvi || 0;

    // Fetch air quality
    const airRes = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${apiKey}`);
    const airData = await airRes.json();
    const air = airData.list[0].components;

    // Affichage qualit√© air texte
    const airList = document.getElementById('airQualityList');
    clearChildren(airList);
    const airMapping = {
      "pm2_5": "Particules fines PM2.5 (¬µg/m¬≥)",
      "pm10": "Particules fines PM10 (¬µg/m¬≥)",
      "o3": "Ozone O3 (¬µg/m¬≥)",
      "no2": "Dioxyde d'azote NO‚ÇÇ (¬µg/m¬≥)",
      "so2": "Dioxyde de soufre SO‚ÇÇ (¬µg/m¬≥)",
      "co": "Monoxyde de carbone CO (¬µg/m¬≥)"
    };
    for (const key in airMapping) {
      const li = document.createElement('li');
      li.textContent = `${airMapping[key]} : ${air[key].toFixed(1)}`;
      airList.appendChild(li);
    }

    // Graphique qualit√© de l'air
    const airLabels = Object.values(airMapping);
    const airValues = Object.keys(airMapping).map(k => air[k]);

    if(airChartInstance) airChartInstance.destroy();
    const ctxAir = document.getElementById("airChart").getContext("2d");
    airChartInstance = new Chart(ctxAir, {
      type: 'bar',
      data: {
        labels: airLabels,
        datasets: [{
          label: "Concentration (¬µg/m¬≥)",
          data: airValues,
          backgroundColor: [
            "#a83232", "#d97f30", "#f3e500", "#39a832", "#2c7ed9", "#9c32a8"
          ],
          borderRadius: 5
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: '¬µg/m¬≥' }
          }
        },
        plugins: { legend: { display: false } }
      }
    });

    // Correction luminosit√© par n√©bulosit√© (cloudiness)
    // On prend % de n√©bulosit√© √† partir de l‚Äôactuel (data from weather)
    // Puis pond√©ration : luminosit√© r√©elle = luminosit√© brute * (1 - n√©bulosit√©/100)
    // Comme on ne poss√®de pas la luminosit√© brute, on simule un max 100% le jour et 0% la nuit.

    // Cherchons dans data.list les luminosit√©s et appliquons correction par n√©bulosit√©
    for(let i=0; i<data.list.length; i++) {
      const dt = data.list[i];
      const cloudiness = dt.clouds.all; // %
      const d = new Date(dt.dt * 1000);
      const sunriseUnix = data.city.sunrise || 0;
      const sunsetUnix = data.city.sunset || 0;
      const isNightTime = (dt.dt < sunriseUnix || dt.dt > sunsetUnix);
      // Luminosit√© brute simul√©e : 100% jour, 0% nuit
      let baseLum = isNightTime ? 0 : 100;
      luminosities[i] = baseLum * (1 - cloudiness/100);
      uvs[i] = uvIndex; // On met m√™me UV partout (simplifi√©)
    }

    // Lumi√®re estim√©e (en %) √† afficher aussi
    // Ajustement pour graphique secondaire (vents + lumi + UV)
    if(windChartInstance) windChartInstance.destroy();
    const ctxWind = document.getElementById("windChart").getContext("2d");
    windChartInstance = new Chart(ctxWind, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: "Vitesse du vent (km/h)",
            data: winds,
            borderColor: "#1f8ef1",
            backgroundColor: "transparent",
            yAxisID: 'y1',
            tension: 0.3,
            fill: false,
            pointRadius: 3,
          },
          {
            label: "Direction du vent (¬∞)",
            data: windDirs,
            borderColor: "#555",
            borderDash: [6,4],
            yAxisID: 'y2',
            fill: false,
            tension: 0.3,
            pointRadius: 2,
          },
          {
            label: "Luminosit√© corrig√©e (%)",
            data: luminosities,
            borderColor: "#f9c74f",
            backgroundColor: "transparent",
            yAxisID: 'y3',
            tension: 0.3,
            fill: false,
            pointRadius: 3,
          },
          {
            label: "Indice UV",
            data: uvs,
            borderColor: "#ef476f",
            backgroundColor: "transparent",
            yAxisID: 'y4',
            tension: 0.3,
            fill: false,
            pointRadius: 3,
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        scales: {
          y1: {
            type: 'linear',
            position: 'left',
            title: { display: true, text: 'Vitesse (km/h)' },
            beginAtZero: true,
          },
          y2: {
            type: 'linear',
            position: 'right',
            offset: true,
            title: { display: true, text: 'Direction (¬∞)' },
            beginAtZero: false,
            min: 0,
            max: 360,
            grid: { drawOnChartArea: false },
          },
          y3: {
            type: 'linear',
            position: 'left',
            offset: true,
            title: { display: true, text: 'Luminosit√© (%)' },
            beginAtZero: true,
            max: 100,
            grid: { drawOnChartArea: false },
          },
          y4: {
            type: 'linear',
            position: 'right',
            offset: true,
            title: { display: true, text: 'Indice UV' },
            beginAtZero: true,
            max: 12,
            grid: { drawOnChartArea: false },
          }
        },
        plugins: {
          legend: { position: 'top', labels: { boxWidth: 12, padding: 10 } },
          tooltip: {
            enabled: true, mode: 'nearest', intersect: false,
            callbacks: {
              label: context => {
                const label = context.dataset.label || '';
                let val = context.parsed.y;
                if(label.includes('Direction du vent')) {
                  const deg = val;
                  const card = degToCardinal(deg);
                  return `${label}: ${deg}¬∞ (${card})`;
                }
                return label + ': ' + val.toFixed(2);
              }
            }
          }
        }
      }
    });

    // Graph principal (temp, humidit√©, pluie/neige, pression)
    if(mainChartInstance) mainChartInstance.destroy();
    const ctxMain = document.getElementById("mainChart").getContext("2d");
    mainChartInstance = new Chart(ctxMain, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: "Temp√©rature (¬∞C)",
            data: temps,
            borderColor: "red",
            backgroundColor: "transparent",
            yAxisID: 'y1',
            tension: 0.3,
            fill: false,
            pointRadius: 3,
          },
          {
            label: "Humidit√© (%)",
            data: humidities,
            borderColor: "blue",
            backgroundColor: "transparent",
            yAxisID: 'y2',
            tension: 0.3,
            fill: false,
            pointRadius: 3,
          },
          {
            label: "Pluie + Neige (mm)",
            data: rains.map((r,i) => r + snows[i]),
            backgroundColor: "rgba(0,0,255,0.5)",
            type: 'bar',
            yAxisID: 'y3',
            borderRadius: 4,
          },
          {
            label: "Pression (hPa)",
            data: pressures,
            borderColor: "gray",
            borderDash: [5,5],
            fill: false,
            yAxisID: 'y4',
            tension: 0.3,
            pointRadius: 2,
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        scales: {
          y1: {
            type: 'linear',
            position: 'left',
            title: { display: true, text: 'Temp√©rature (¬∞C)' },
            grid: { drawOnChartArea: true },
            beginAtZero: false,
          },
          y2: {
            type: 'linear',
            position: 'right',
            offset: true,
            title: { display: true, text: 'Humidit√© (%)' },
            grid: { drawOnChartArea: false },
            beginAtZero: true,
            max: 100,
          },
          y3: {
            type: 'linear',
            position: 'right',
            offset: true,
            title: { display: true, text: 'Pr√©cipitations (mm)' },
            grid: { drawOnChartArea: false },
            beginAtZero: true,
          },
          y4: {
            type: 'linear',
            position: 'left',
            offset: true,
            title: { display: true, text: 'Pression (hPa)' },
            grid: { drawOnChartArea: false },
            beginAtZero: false,
          }
        },
        plugins: {
          legend: { position: 'top', labels: { boxWidth: 12, padding: 10 } },
          tooltip: {
            enabled: true, mode: 'nearest', intersect: false,
            callbacks: {
              label: context => {
                const label = context.dataset.label || '';
                let val = context.parsed.y;
                return label + ': ' + val.toFixed(2);
              }
            }
          }
        }
      }
    });

    // Dessiner la phase de lune
    const phase = calculateMoonPhase(new Date());
    drawMoon(phase);

  } catch (e) {
    console.error("Erreur r√©cup√©ration pr√©visions :", e);
    alert("Erreur lors de la r√©cup√©ration des pr√©visions m√©t√©o.");
  }
}

async function main() {
  const currentData = await fetchWeather();
  await fetchForecast();
}
main();

window.addEventListener('resize', () => {
  main();
});
</script>
</body>
</html>
