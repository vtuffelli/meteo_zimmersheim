<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Météo complète avec Open-Meteo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    /* ==== Styles (inchangés) ==== */
    body, html {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom, #87ceeb, #f0f8ff);
      color: #222;
      overflow-x: hidden;
    }
    #background-anim {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: -1;
      pointer-events: none;
      overflow: hidden;
    }
    .cloud {
      position: absolute;
      background: linear-gradient(to bottom, #f0f4f8, #cbd6e8);
      border-radius: 50px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
      animation: cloudMove linear infinite;
      opacity: 0.8;
    }
    .cloud::before, .cloud::after {
      content: '';
      position: absolute;
      background: inherit;
      border-radius: 50px;
    }
    .cloud::before {
      width: 60px; height: 60px;
      top: -30px; left: 10px;
    }
    .cloud::after {
      width: 50px; height: 50px;
      top: -20px; left: 45px;
    }
    @keyframes cloudMove {
      0% { left: -150px; }
      100% { left: 110vw; }
    }
    #container {
      display: flex;
      max-width: 1200px;
      margin: 30px auto;
      gap: 20px;
      flex-wrap: wrap;
    }
    #left-panel {
      flex: 1 1 350px;
      background: rgba(255,255,255,0.9);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 30px rgba(0,0,0,0.1);
      user-select: none;
      max-width: 400px;
      font-family: Arial, sans-serif;
    }
    #right-panel {
      flex: 1 1 600px;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(0,0,0,0.1);
      background: rgba(255,255,255,0.95);
      padding: 20px;
    }
    h1, h2 {
      margin-bottom: 15px;
      user-select: none;
      text-align: center;
    }
    .info-row {
      margin: 6px 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .label {
      font-weight: 700;
      color: #555;
      min-width: 130px;
    }
    #condition-icon {
      display: block;
      margin: 10px auto;
      width: 100px; height: 100px;
    }
    #wind-arrow {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-left: 8px;
      vertical-align: middle;
      transition: transform 0.3s ease;
    }
    #moon-phase {
      margin-left: 8px;
      font-size: 1.4rem;
    }
    #moon-phase-desc {
      font-size: 1rem;
      color: #555;
    }
    section.chart-section {
      background: rgba(255,255,255,0.95);
      margin: 30px auto;
      max-width: 1200px;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 30px rgba(0,0,0,0.08);
      user-select: none;
    }
    canvas {
      width: 100% !important;
      max-height: 400px !important;
    }
    .air-legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 1rem;
      gap: 1rem;
      font-family: sans-serif;
      font-size: 14px;
    }
    .air-legend div {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .air-legend span {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }
    @media (max-width: 600px) {
      .air-legend {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div id="background-anim"></div>
  <div id="container">
    <div id="left-panel">
      <h1>Météo actuelle</h1>
      <img id="condition-icon" src="" alt="Icône météo" />
      <div class="info-row"><span class="label">Condition :</span> <span id="description"></span></div>
      <div class="info-row"><span class="label">Température :</span> <span id="temp"></span> °C</div>
      <div class="info-row"><span class="label">Température ressentie :</span> <span id="feels-like"></span> °C</div>
      <div class="info-row"><span class="label">Température min :</span> <span id="temp-min"></span> °C</div>
      <div class="info-row"><span class="label">Température max :</span> <span id="temp-max"></span> °C</div>
      <div class="info-row"><span class="label">Humidité :</span> <span id="humidity"></span> %</div>
      <div class="info-row"><span class="label">Couverture nuageuse :</span> <span id="clouds"></span> %</div>
      <div class="info-row"><span class="label">Précipitations (1h) :</span> <span id="precip"></span></div>
      <div class="info-row"><span class="label">Pression :</span> <span id="pressure"></span> hPa</div>
      <div class="info-row">
        <span class="label">Vent :</span>
        <span id="wind"></span> km/h
        <svg id="wind-arrow" viewBox="0 0 24 24" fill="none" stroke="#0077cc" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="19" x2="12" y2="5"></line>
          <polyline points="5 12 12 5 19 12"></polyline>
        </svg>
      </div>
      <div class="info-row"><span class="label">Direction vent :</span> <span id="wind-dir"></span></div>
      <div class="info-row"><span class="label">Lever du soleil :</span> <span id="sunrise"></span></div>
      <div class="info-row"><span class="label">Coucher du soleil :</span> <span id="sunset"></span></div>
      <div class="info-row"><span class="label">Indice UV :</span> <span id="uv-index"></span></div>
      <div class="info-row" style="font-weight: bold; font-size: 1.2rem; margin-bottom: 10px;">
        Indice AQI estimé : <span id="aqi-global">Chargement...</span>
      </div>
      <div class="info-row">
        <span class="label">Phase lunaire :</span>
        <span id="moon-phase-desc">Chargement...</span>
        <span id="moon-phase">🌑</span>
      </div>
    </div>
    <div id="right-panel">
      <h2 style="text-align:center; padding: 10px 0;">Qualité de l'air</h2>
      <div id="air-quality-details"></div>
    </div>
  </div>

  <section class="chart-section">
    <h2>📊 Graphique principal</h2>
    <canvas id="mainChart"></canvas>
  </section>

  <section class="chart-section">
    <h2>📊 Graphique secondaire (vent + nuages)</h2>
    <canvas id="windChart"></canvas>
  </section>

  <section class="chart-section">
    <h2>📊 Graphique qualité de l'air</h2>
    <canvas id="airChart"></canvas>

    <div id="airLegend" class="air-legend">
      <div><span style="background-color:#4caf50;"></span> Excellente</div>
      <div><span style="background-color:#cddc39;"></span> Acceptable</div>
      <div><span style="background-color:#ffc107;"></span> Moyenne</div>
      <div><span style="background-color:#ff5722;"></span> Mauvaise</div>
      <div><span style="background-color:#b71c1c;"></span> Très mauvaise</div>
    </div>
  </section>

<script>
  // Coordonnées Zimmersheim
  const lat = 47.7746;
  const lon = 7.3373;

  /* ==== Fonctions utilitaires ==== */

  function degToCardinal(deg) {
    const dirs = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
                  "S", "SSO", "SO", "OSO", "O", "ONO", "NO", "NNO"];
    return dirs[Math.round(deg / 22.5) % 16];
  }

  function formatTimeISO8601(dateStr) {
    return new Date(dateStr).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  }

  function getMoonPhaseWithDescription(date) {
    const lp = 2551443;
    const new_moon = new Date(1970,0,7,20,35,0);
    const phase = ((date.getTime() - new_moon.getTime())/1000) % lp;
    const percent = (phase / lp);
    const index = Math.floor(percent * 8);
    const phases = [
      { icon: '🌑', label: 'Nouvelle lune' },
      { icon: '🌒', label: 'Premier croissant' },
      { icon: '🌓', label: 'Premier quartier' },
      { icon: '🌔', label: 'Lune gibbeuse croissante' },
      { icon: '🌕', label: 'Pleine lune' },
      { icon: '🌖', label: 'Lune gibbeuse décroissante' },
      { icon: '🌗', label: 'Dernier quartier' },
      { icon: '🌘', label: 'Dernier croissant' }
    ];
    return phases[index];
  }

  /* ==== API Open-Meteo - Fetch météo actuelle et données ==== */
  async function fetchWeather() {
    // Open-Meteo endpoint météo actuelle + indicateurs complémentaires
    // https://open-meteo.com/fr/docs#latitude=47.7746&longitude=7.3373&hourly=temperature_2m,precipitation,rain,showers,snowfall,cloudcover,weathercode,windspeed_10m,winddirection_10m,uv_index&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max&current_weather=true&timezone=Europe%2FBerlin

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
      + `&current_weather=true&hourly=precipitation,weathercode,cloudcover,uv_index,windspeed_10m,winddirection_10m`
      + `&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max`
      + `&timezone=Europe/Berlin`;

    const res = await fetch(url);
    const data = await res.json();

    // console.log('Météo brute:', data);

    // Current weather
    const cw = data.current_weather;
    if (!cw) {
      alert('Erreur: pas de météo actuelle trouvée.');
      return;
    }

    // Temps actuel détaillé
    const timeIndex = data.hourly.time.findIndex(t => t === cw.time);
    const humidity = data.hourly.relativehumidity_2m ? data.hourly.relativehumidity_2m[timeIndex] : null;
    const pressure = data.hourly.pressure_msl ? data.hourly.pressure_msl[timeIndex] : null;
    const cloudcover = data.hourly.cloudcover ? data.hourly.cloudcover[timeIndex] : null;
    const precipitation = data.hourly.precipitation ? data.hourly.precipitation[timeIndex] : 0;
    const uvIndex = data.hourly.uv_index ? data.hourly.uv_index[timeIndex] : 0;

    // Affichage météo actuelle
    document.getElementById("temp").textContent = cw.temperature.toFixed(1);
    document.getElementById("feels-like").textContent = "N/A"; // non dispo via Open-Meteo
    document.getElementById("humidity").textContent = humidity !== null ? humidity : "N/A";
    document.getElementById("pressure").textContent = pressure !== null ? pressure.toFixed(0) : "N/A";
    document.getElementById("clouds").textContent = cloudcover !== null ? cloudcover : "N/A";
    document.getElementById("precip").textContent = precipitation ? precipitation.toFixed(1) + " mm" : "Aucune";
    document.getElementById("wind").textContent = (cw.windspeed * 3.6).toFixed(1);
    document.getElementById("wind-dir").textContent = `${degToCardinal(cw.winddirection)} (${cw.winddirection}°)`;

    // Rotation flèche vent
    const arrow = document.getElementById("wind-arrow");
    if (arrow) {
      arrow.style.transformOrigin = "50% 50%";
      arrow.style.transform = `rotate(${cw.winddirection}deg)`;
    }

    // Lever / coucher du soleil (aujourd'hui)
    const today = new Date().toISOString().slice(0,10);
    const dailyIndex = data.daily.time.indexOf(today);
    document.getElementById("sunrise").textContent = dailyIndex >= 0 ? formatTimeISO8601(data.daily.sunrise[dailyIndex]) : "N/A";
    document.getElementById("sunset").textContent = dailyIndex >= 0 ? formatTimeISO8601(data.daily.sunset[dailyIndex]) : "N/A";

    // Condition météo (Open-Meteo utilise des codes, on mappe ici en texte + icône)
    const weatherCodeMap = {
      0: ["Ciel clair", "☀️"],
      1: ["Principalement clair", "🌤️"],
      2: ["Partiellement nuageux", "⛅"],
      3: ["Couvert", "☁️"],
      45: ["Brouillard léger", "🌫️"],
      48: ["Brouillard givrant", "🌫️"],
      51: ["Bruine légère", "🌦️"],
      53: ["Bruine modérée", "🌧️"],
      55: ["Bruine dense", "🌧️"],
      56: ["Bruine verglaçante légère", "🌧️❄️"],
      57: ["Bruine verglaçante dense", "🌧️❄️"],
      61: ["Pluie légère", "🌧️"],
      63: ["Pluie modérée", "🌧️"],
      65: ["Pluie forte", "🌧️"],
      66: ["Pluie verglaçante légère", "🌧️❄️"],
      67: ["Pluie verglaçante forte", "🌧️❄️"],
      71: ["Neige légère", "❄️"],
      73: ["Neige modérée", "❄️"],
      75: ["Neige forte", "❄️"],
      77: ["Grains de neige", "❄️"],
      80: ["Averses de pluie légères", "🌧️"],
      81: ["Averses de pluie modérées", "🌧️"],
      82: ["Averses de pluie violentes", "🌧️"],
      85: ["Averses de neige légères", "❄️"],
      86: ["Averses de neige violentes", "❄️"],
      95: ["Orage modéré", "⛈️"],
      96: ["Orage avec grêle légère", "⛈️"],
      99: ["Orage avec grêle forte", "⛈️"],
    };
    const [desc, icon] = weatherCodeMap[cw.weathercode] || ["Inconnu", "❓"];
    document.getElementById("description").textContent = desc;
    document.getElementById("condition-icon").textContent = icon;

    // Indice UV max aujourd'hui
    const uvMax = dailyIndex >= 0 ? data.daily.uv_index_max[dailyIndex] : 0;
    document.getElementById("uv-index").textContent = uvMax.toFixed(1);

    return {
      current: cw,
      hourly: data.hourly,
      daily: data.daily,
      weatherDesc: desc,
      weatherIcon: icon,
      uvIndex: uvMax
    };
  }

  /* ==== API qualité de l'air (Open-Meteo) ==== */
  async function fetchAirQuality() {
    // Endpoint qualité de l'air
    // Docs: https://open-meteo.com/en/docs/air-quality-api
    const url = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm10,pm2_5,o3,no2,co,so2,nh3&timezone=Europe/Berlin`;
    const res = await fetch(url);
    const data = await res.json();

    // console.log('Qualité de l’air brute:', data);

    const timeNowISO = new Date().toISOString().slice(0,13) + ":00"; // YYYY-MM-DDTHH:00
    const timeIndex = data.hourly.time.indexOf(timeNowISO);

    if (timeIndex === -1) {
      alert("Données qualité de l'air indisponibles pour l'heure actuelle.");
      return null;
    }

    // Polluants
    const pollutants = {
      pm10: data.hourly.pm10[timeIndex],
      pm2_5: data.hourly.pm2_5[timeIndex],
      o3: data.hourly.o3[timeIndex],
      no2: data.hourly.no2[timeIndex],
      co: data.hourly.co[timeIndex],
      so2: data.hourly.so2[timeIndex],
      nh3: data.hourly.nh3[timeIndex],
    };

    // Affichage détails polluants
    const airDiv = document.getElementById("air-quality-details");
    airDiv.innerHTML = '';
    for (const [key, val] of Object.entries(pollutants)) {
      const nameMap = {
        pm10: 'PM10',
        pm2_5: 'PM2.5',
        o3: 'Ozone (O3)',
        no2: 'Dioxyde d\'azote (NO2)',
        co: 'Monoxyde de carbone (CO)',
        so2: 'Dioxyde de soufre (SO2)',
        nh3: 'Ammoniac (NH3)'
      };
      const unit = (key === 'co') ? 'µg/m³' : 'µg/m³';
      const p = document.createElement('div');
      p.textContent = `${nameMap[key]} : ${val !== null ? val.toFixed(1) : 'N/A'} ${unit}`;
      airDiv.appendChild(p);
    }

    // Estimation simplifiée AQI global (basée sur PM2.5 et PM10 principalement)
    // Source: https://fr.wikipedia.org/wiki/Indice_de_qualité_de_l%27air
    // On fait une moyenne pondérée ici (à ajuster si besoin)
    function getAQIColor(aqi) {
      if (aqi <= 20) return '#4caf50';       // Excellente
      if (aqi <= 40) return '#cddc39';       // Acceptable
      if (aqi <= 60) return '#ffc107';       // Moyenne
      if (aqi <= 80) return '#ff5722';       // Mauvaise
      return '#b71c1c';                      // Très mauvaise
    }
    const aqiEstimate = Math.round((pollutants.pm2_5 * 2 + pollutants.pm10) / 3);
    const aqiColor = getAQIColor(aqiEstimate);
    const aqiSpan = document.getElementById('aqi-global');
    aqiSpan.textContent = aqiEstimate;
    aqiSpan.style.color = aqiColor;

    return {
      pollutants,
      aqiEstimate,
      aqiColor
    };
  }

  /* ==== Graphiques Chart.js ==== */
  let mainChart, windChart, airChart;

  function createMainChart(hourly) {
    if (mainChart) mainChart.destroy();

    // Préparation données (température, précipitations, uv, weathercode)
    const labels = hourly.time.map(t => t.slice(11,16));
    const temps = hourly.temperature_2m || [];
    const precip = hourly.precipitation || [];
    const uv = hourly.uv_index || [];
    const clouds = hourly.cloudcover || [];

    const ctx = document.getElementById('mainChart').getContext('2d');
    mainChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Température (°C)',
            data: temps,
            borderColor: '#ff5722',
            backgroundColor: '#ffccbc',
            yAxisID: 'y1',
            tension: 0.3,
            fill: true,
          },
          {
            label: 'Précipitations (mm)',
            data: precip,
            type: 'bar',
            backgroundColor: '#2196f3',
            yAxisID: 'y2',
          },
          {
            label: 'Indice UV',
            data: uv,
            borderColor: '#fbc02d',
            backgroundColor: '#fff59d',
            yAxisID: 'y3',
            tension: 0.3,
            fill: true,
          },
          {
            label: 'Couverture nuageuse (%)',
            data: clouds,
            borderColor: '#90a4ae',
            backgroundColor: '#cfd8dc',
            yAxisID: 'y4',
            tension: 0.3,
            fill: true,
          }
        ]
      },
      options: {
        interaction: {
          mode: 'index',
          intersect: false
        },
        stacked: false,
        scales: {
          y1: {
            type: 'linear',
            position: 'left',
            title: { display: true, text: 'Température (°C)' },
            min: Math.min(...temps) - 5,
            max: Math.max(...temps) + 5,
          },
          y2: {
            type: 'linear',
            position: 'right',
            title: { display: true, text: 'Précipitations (mm)' },
            grid: { drawOnChartArea: false },
          },
          y3: {
            type: 'linear',
            position: 'right',
            offset: true,
            title: { display: true, text: 'Indice UV' },
            grid: { drawOnChartArea: false },
            min: 0,
            max: Math.max(...uv) + 2,
          },
          y4: {
            type: 'linear',
            position: 'right',
            offset: true,
            title: { display: true, text: 'Couverture nuageuse (%)' },
            grid: { drawOnChartArea: false },
            min: 0,
            max: 100,
          }
        },
        plugins: {
          legend: { position: 'top' },
          tooltip: { enabled: true }
        }
      }
    });
  }

  function createWindChart(hourly) {
    if (windChart) windChart.destroy();

    const labels = hourly.time.map(t => t.slice(11,16));
    const windSpeed = hourly.windspeed_10m ? hourly.windspeed_10m.map(s => s * 3.6) : [];
    const windDir = hourly.winddirection_10m || [];
    const cloudCover = hourly.cloudcover || [];

    const ctx = document.getElementById('windChart').getContext('2d');
    windChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Vitesse du vent (km/h)',
            data: windSpeed,
            borderColor: '#0077cc',
            backgroundColor: '#bbdefb',
            yAxisID: 'y1',
            tension: 0.3,
            fill: true,
          },
          {
            label: 'Couverture nuageuse (%)',
            data: cloudCover,
            borderColor: '#90a4ae',
            backgroundColor: '#cfd8dc',
            yAxisID: 'y2',
            tension: 0.3,
            fill: true,
          }
        ]
      },
      options: {
        interaction: {
          mode: 'index',
          intersect: false
        },
        stacked: false,
        scales: {
          y1: {
            type: 'linear',
            position: 'left',
            title: { display: true, text: 'Vitesse du vent (km/h)' },
            min: 0,
            max: Math.max(...windSpeed) + 5,
          },
          y2: {
            type: 'linear',
            position: 'right',
            title: { display: true, text: 'Couverture nuageuse (%)' },
            grid: { drawOnChartArea: false },
            min: 0,
            max: 100,
          }
        },
        plugins: {
          legend: { position: 'top' },
          tooltip: { enabled: true }
        }
      }
    });
  }

  function createAirChart(pollutants) {
    if (airChart) airChart.destroy();

    const labels = Object.keys(pollutants).map(p => p.toUpperCase());
    const dataVals = Object.values(pollutants).map(v => v);

    // Couleurs selon concentration (arbitraire)
    const bgColors = dataVals.map(val => {
      if (val <= 20) return '#4caf50';       // Excellente
      if (val <= 40) return '#cddc39';       // Acceptable
      if (val <= 60) return '#ffc107';       // Moyenne
      if (val <= 80) return '#ff5722';       // Mauvaise
      return '#b71c1c';                      // Très mauvaise
    });

    const ctx = document.getElementById('airChart').getContext('2d');
    airChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Concentration polluants (µg/m³)',
          data: dataVals,
          backgroundColor: bgColors,
          borderRadius: 5
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            max: Math.max(...dataVals) + 20
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        }
      }
    });
  }

  /* ==== Animation nuages ==== */
  function createClouds(num=10) {
    const container = document.getElementById("background-anim");
    container.innerHTML = "";
    for (let i=0; i<num; i++) {
      const c = document.createElement("div");
      c.className = "cloud";
      const size = 40 + Math.random()*80;
      c.style.width = size + "px";
      c.style.height = size * 0.6 + "px";
      c.style.top = (Math.random()*70) + "vh";
      c.style.animationDuration = (60 + Math.random()*60) + "s";
      c.style.left = (-100 - Math.random()*200) + "px";
      container.appendChild(c);
    }
  }

  /* ==== Lancement ==== */
  async function init() {
    createClouds(12);
    const weather = await fetchWeather();
    const air = await fetchAirQuality();

    if (weather) {
      createMainChart(weather.hourly);
      createWindChart(weather.hourly);
      // Phase lunaire
      const moonPhaseData = getMoonPhaseWithDescription(new Date());
      document.getElementById('moon-phase').textContent = moonPhaseData.icon;
      document.getElementById('moon-phase-desc').textContent = moonPhaseData.label;
    }
    if (air) {
      createAirChart(air.pollutants);
    }
  }

  init();

</script>
</body>
</html>
