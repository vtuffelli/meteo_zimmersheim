<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MÃ©tÃ©o complÃ¨te Zimmersheim - Open-Meteo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom, #87ceeb, #f0f8ff);
      color: #222;
      overflow-x: hidden;
    }
    #container {
      display: flex;
      max-width: 1200px;
      margin: 30px auto;
      gap: 20px;
      flex-wrap: wrap;
    }
    #left-panel, #right-panel {
      flex: 1 1 400px;
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 30px rgba(0,0,0,0.1);
    }
    .info-row {
      margin: 6px 0;
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
    }
    .label {
      font-weight: bold;
      min-width: 130px;
    }
    canvas {
      width: 100% !important;
      max-height: 400px !important;
    }
    section.chart-section {
      background: rgba(255,255,255,0.95);
      margin: 30px auto;
      max-width: 1200px;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 30px rgba(0,0,0,0.08);
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="left-panel">
      <h2>MÃ©tÃ©o actuelle - Zimmersheim</h2>
      <div class="info-row"><span class="label">TempÃ©rature :</span><span id="temp"></span> Â°C</div>
      <div class="info-row"><span class="label">TempÃ©rature ressentie :</span><span id="feelslike"></span> Â°C</div>
      <div class="info-row"><span class="label">Vent :</span><span id="wind"></span> km/h</div>
      <div class="info-row"><span class="label">Orientation :</span><span id="winddir"></span></div>
      <div class="info-row"><span class="label">HumiditÃ© :</span><span id="humidity"></span> %</div>
      <div class="info-row"><span class="label">Couverture nuageuse :</span><span id="clouds"></span> %</div>
      <div class="info-row"><span class="label">Pression :</span><span id="pressure"></span> hPa</div>
      <div class="info-row"><span class="label">UV :</span><span id="uv"></span></div>
      <div class="info-row"><span class="label">Phase lunaire :</span><span id="moon"></span></div>
    </div>
    <div id="right-panel">
      <h2>QualitÃ© de l'air - Zimmersheim</h2>
      <div id="air-quality"></div>
    </div>
  </div>

  <section class="chart-section">
    <h2>Graphique MÃ©tÃ©o</h2>
    <canvas id="mainChart"></canvas>
  </section>
  <section class="chart-section">
    <h2>Vent, UV et Nuages</h2>
    <canvas id="windChart"></canvas>
  </section>
  <section class="chart-section">
    <h2>QualitÃ© de l'air</h2>
    <canvas id="airChart"></canvas>
  </section>

  <script>
    const lat = 47.744;
    const lon = 7.397;
    const windDirs = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSO", "SO", "OSO", "O", "ONO", "NO", "NNO"];

    function degToCardinal(deg) {
      return windDirs[Math.round(deg / 22.5) % 16];
    }

    async function fetchWeather() {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,apparent_temperature,cloudcover,relative_humidity_2m,pressure_msl,uv_index,wind_speed_10m,wind_direction_10m&daily=uv_index_max,precipitation_sum,wind_speed_10m_max,sunrise,sunset,moon_phase&current=temperature_2m,apparent_temperature,cloudcover,pressure_msl,relative_humidity_2m,wind_speed_10m,wind_direction_10m,uv_index,is_day&timezone=auto`;
      const res = await fetch(url);
      const data = await res.json();

      const c = data.current;
      document.getElementById("temp").textContent = c.temperature_2m.toFixed(1);
      document.getElementById("feelslike").textContent = c.apparent_temperature.toFixed(1);
      document.getElementById("wind").textContent = c.wind_speed_10m.toFixed(1);
      document.getElementById("winddir").textContent = `${degToCardinal(c.wind_direction_10m)} (${c.wind_direction_10m}Â°)`;
      document.getElementById("humidity").textContent = c.relative_humidity_2m;
      document.getElementById("clouds").textContent = c.cloudcover;
      document.getElementById("pressure").textContent = c.pressure_msl;
      document.getElementById("uv").textContent = c.uv_index.toFixed(1);

      const moonIcons = ['ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜'];
      const phase = Math.round(data.daily.moon_phase[0] * 7);
      document.getElementById("moon").textContent = moonIcons[phase];

      const hours = data.hourly.time.map(t => new Date(t).toLocaleString('fr-FR', { hour: '2-digit', day: '2-digit', month: '2-digit' }));

      new Chart(document.getElementById("mainChart"), {
        type: 'line',
        data: {
          labels: hours,
          datasets: [
            {
              label: 'TempÃ©rature (Â°C)',
              data: data.hourly.temperature_2m,
              borderColor: 'red',
              fill: false,
              tension: 0.3,
            },
            {
              label: 'Ressentie (Â°C)',
              data: data.hourly.apparent_temperature,
              borderColor: 'orange',
              fill: false,
              tension: 0.3,
            },
            {
              label: 'HumiditÃ© (%)',
              data: data.hourly.relative_humidity_2m,
              borderColor: 'blue',
              fill: false,
              tension: 0.3,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'TempÃ©rature (Â°C)' } },
            y1: {
              position: 'right',
              beginAtZero: true,
              title: { display: true, text: 'HumiditÃ© (%)' },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      new Chart(document.getElementById("windChart"), {
        type: 'line',
        data: {
          labels: hours,
          datasets: [
            {
              label: 'Vent (km/h)',
              data: data.hourly.wind_speed_10m,
              borderColor: 'green',
              fill: false,
              tension: 0.3,
              yAxisID: 'y'
            },
            {
              label: 'Nuages (%)',
              data: data.hourly.cloudcover,
              borderColor: 'gray',
              fill: false,
              tension: 0.3,
              yAxisID: 'y1'
            },
            {
              label: 'Direction vent',
              data: data.hourly.wind_direction_10m.map(d => Math.round(d / 22.5) % 16),
              borderColor: 'black',
              borderDash: [5, 5],
              fill: false,
              tension: 0.3,
              yAxisID: 'y2'
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { title: { display: true, text: 'Vent (km/h)' } },
            y1: {
              position: 'right',
              title: { display: true, text: 'Nuages (%)' },
              grid: { drawOnChartArea: false }
            },
            y2: {
              position: 'right',
              title: { display: true, text: 'Orientation' },
              ticks: {
                stepSize: 1,
                callback: (v) => windDirs[v] || ''
              },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
    }

    async function fetchAirQuality() {
      const url = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm10,pm2_5,carbon_monoxide,nitrogen_dioxide,ozone,sulphur_dioxide&timezone=auto`;
      const res = await fetch(url);
      const data = await res.json();

      const i = 0;
      const airLabels = ['PM10','PM2.5','CO','NO2','O3','SO2'];
      const airValues = [data.hourly.pm10[i], data.hourly.pm2_5[i], data.hourly.carbon_monoxide[i], data.hourly.nitrogen_dioxide[i], data.hourly.ozone[i], data.hourly.sulphur_dioxide[i]];
      const colors = airValues.map(v => v < 20 ? '#4caf50' : v < 50 ? '#ffeb3b' : v < 100 ? '#ff9800' : '#f44336');
      const airHTML = airLabels.map((lbl, i) => `<div><b>${lbl}</b> : ${airValues[i].toFixed(2)} Âµg/mÂ³</div>`).join('');
      document.getElementById("air-quality").innerHTML = airHTML;

      new Chart(document.getElementById("airChart"), {
        type: 'bar',
        data: {
          labels: airLabels,
          datasets: [{
            label: 'QualitÃ© de l'air (Âµg/mÂ³)',
            data: airValues,
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          plugins: {
            datalabels: {
              anchor: 'end',
              align: 'top',
              formatter: val => val.toFixed(2),
              font: { weight: 'bold' }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Concentration (Âµg/mÂ³)' }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    fetchWeather();
    fetchAirQuality();
  </script>
</body>
</html>
